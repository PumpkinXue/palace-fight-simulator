<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>宫廷模拟器 - 后宫浮生记</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 新增：手机端视口适配，必须加 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- 你的其他样式/脚本引入 -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Serif+SC:wght@400;700&display=swap');

        /* === 字体与背景 === */
        body { font-family: 'Noto Serif SC', serif; background-color: #2b0e0e; }
        .font-ancient { font-family: 'Ma Shan Zheng', cursive; }
        
        /* 宣纸纹理背景 */
        .bg-silk { 
            background-color: #fdfbf7; 
            background-image: url("https://www.transparenttextures.com/patterns/natural-paper.png");
            box-shadow: inset 0 0 60px rgba(66, 30, 10, 0.15);
        }

        /* === UI 组件样式 === */
        /* 宫廷按钮 */
        .btn-palace { 
            @apply relative overflow-hidden bg-gradient-to-b from-red-900 to-red-950 text-[#f3e5ab] font-bold py-3 px-4 rounded border-2 border-[#8B4513] shadow-md transition-all duration-300;
            font-family: 'Noto Serif SC', serif;
            letter-spacing: 1px;
        }
        .btn-palace:hover {
            @apply from-red-800 to-red-900 border-[#DAA520] text-white transform -translate-y-0.5 shadow-lg;
        }
        .btn-palace:active {
            @apply transform translate-y-0 scale-95;
        }
        .btn-palace:disabled {
            @apply opacity-50 cursor-not-allowed filter grayscale;
        }

        /* 模态框背景 */
        .modal-bg { background-color: rgba(0,0,0,0.85); backdrop-filter: blur(2px); }

        /* 滚动条美化 */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background-color: #8B4513; border-radius: 3px; }
        ::-webkit-scrollbar-track { background-color: #e5e5e5; }

        /* 动画 */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        .animate-fade-in { animation: fadeIn 0.8s ease-out forwards; }
        .animate-slide-up { animation: slideUp 0.6s ease-out forwards; }
        .animate-spin { animation: spin 1.5s linear infinite; }

        /* === 特定区域样式 === */
        /* 存档位 */
        .save-slot {
            @apply border-2 border-[#d6cbb0] bg-[#fcfaf2] transition-all duration-300 hover:border-[#8B4513] hover:shadow-md;
        }
        
        /* 侍寝/事件条目 */
        .event-item-box {
            @apply border-b border-stone-300/50 py-2 last:border-0;
        }

        /* ======== 新增：游戏须知弹窗样式 ======== */
        .tab-btn {
            cursor: pointer;
            background: transparent;
            border: none;
        }
        .tab-btn.active {
            color: #8B4513;
        }
        .tab-content {
            display: none;
        }
        .tab-content.block {
            display: block;
        }
        #gameGuideModal .tab-content {
            white-space: pre-line;
        }
        /* ======== 弹窗样式结束 ======== */
        /* ======== 自动存档提示样式 - 古风顶部提示，自动消失 ======== */
        #autoSaveTip {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 999999;
            background: #3e1f1f;
            color: #f3e5ab;
            border: 2px solid #8B4513;
            padding: 6px 20px;
            border-radius: 50px;
            font-family: 'Noto Serif SC', serif;
            font-size: 12px;
            font-weight: bold;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease;
        }
        #autoSaveTip.show {
            opacity: 1;
        }

        /* 六宫妃嫔列表滑块样式 */
        #concubine-list {
            scrollbar-width: thin;
            scrollbar-color: #8B4513 #f5f5f5;
            -webkit-overflow-scrolling: touch; /* 移动端平滑滚动 */
        }

        #concubine-list::-webkit-scrollbar {
            height: 6px;
        }

        #concubine-list::-webkit-scrollbar-thumb {
            background-color: #8B4513;
            border-radius: 3px;
        }

        #concubine-list::-webkit-scrollbar-track {
            background-color: #f5f5f5;
        }

        /* 妃嫔卡片样式 */
        #concubine-list > div {
            transition: transform 0.2s, box-shadow 0.2s;
        }

        #concubine-list > div:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 69, 19, 0.2);
        }

        /* 妃嫔变动显示样式 */
        #result-changes-grid .text-yellow-600 {
            color: #d97706; /* 橙色-黄色调，表示圣宠 */
        }

        #result-changes-grid .text-purple-600 {
            color: #7c3aed; /* 紫色调，表示权势 */
        }

        /* 调整字体大小，使多个变动时更清晰 */
        #result-changes-grid .text-xs {
            font-size: 0.7rem;
            line-height: 1.2;
        }

        /* 资历显示样式 */
        .bg-purple-50 {
            background-color: #faf5ff;
        }

        .bg-purple-50 .font-bold {
            color: #6d28d9;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-2 md:p-6 overflow-hidden bg-[url('https://www.transparenttextures.com/patterns/black-scales.png')]">

    <!-- 全局加载遮罩 (AI生成时显示) -->
    <div id="ai-loading-overlay" class="hidden fixed inset-0 z-[9999] modal-bg flex flex-col items-center justify-center text-[#f3e5ab]">
        <div class="bg-black/60 p-8 rounded-xl border-2 border-[#DAA520] text-center max-w-sm mx-4 backdrop-blur-md shadow-2xl">
            <div class="w-12 h-12 border-4 border-t-[#DAA520] border-r-transparent border-b-[#8B4513] border-l-transparent rounded-full animate-spin mx-auto mb-6"></div>
            <h3 class="text-3xl font-ancient text-[#DAA520] mb-3">天机推演中</h3>
            <p class="text-sm text-stone-300 mb-4 tracking-wider">大模型正在生成剧情...</p>
            <div class="h-1 w-full bg-stone-700 rounded-full overflow-hidden">
                <div class="h-full bg-[#DAA520] animate-pulse w-3/4 mx-auto rounded-full"></div>
            </div>
            <p class="text-xs text-stone-500 mt-4 italic">（预计耗时约 1 分钟，请勿关闭页面）</p>
        </div>
    </div>

    <!-- ======== 新增：游戏须知弹窗（开局强制弹出，左下角常驻按钮）======== -->
    <div id="gameGuideModal" class="fixed inset-0 z-[99999] flex items-center justify-center bg-black/70 px-2 md:px-0" style="display:flex !important;">
        <div class="w-full max-w-xl bg-[#f5f0e6] rounded-lg border-[4px] border-[#8B4513] shadow-2xl overflow-hidden">
            <!-- 弹窗头部 -->
            <div class="bg-[#3e1f1f] text-[#f3e5ab] py-2 px-4 flex justify-between items-center">
                <h2 class="font-bold text-lg md:text-base">📖 后宫浮生记 · 游戏须知</h2>
                <button onclick="closeGameGuide()" class="text-[#f3e5ab] hover:text-white text-xl cursor-pointer">&times;</button>
            </div>
            <!-- 弹窗标签栏 -->
            <div class="flex bg-[#e9d8c7] border-b border-[#d4b996]">
                <button onclick="showTab('guide')" class="tab-btn active flex-1 py-2 font-bold text-[#5a3e36] border-b-2 border-[#8B4513]">新手必看</button>
                <button onclick="showTab('update')" class="tab-btn flex-1 py-2 font-bold text-[#8b7355]">更新日记</button>
            </div>
            <!-- 弹窗内容区 -->
            <div class="p-4 max-h-[70vh] overflow-y-auto text-sm md:text-xs leading-relaxed text-[#3e1f1f]">
                <!-- 新手必看内容 -->
                <div id="guide" class="tab-content block">
    大家好！欢迎体验后宫浮生记，想必现在的各位玩家都是蒜雪（化名）最亲爱的朋友~感谢你们的支持。
    <br><br>
    本游戏功能尚不完善，目前仅开发了触发事件系统与晋升系统，后续预计还会陆续加入子嗣系统、下毒系统等，玩法也会更加的丰富，欢迎各位集思广益，给我提供一些宝贵建议呀~
    <br><br>
    -----最重要的一点！！-----
    <br>
    本游戏主要围绕着宫斗故事展开，你的每一步选择将由deepseek驱动演绎，走向不同结局。宫斗只是本游戏的设定，不代表任何世界观，不代表雌竞，仅为架空玩法。
    <br><br>
    好了，废话不多说，下面开始本游戏主要的玩法说明：
    <br>
    1.开局选身份，目前仅支持秀女。（后续预计加入宫女线、乐姬线、贵女线（背负着家族使命而来，家里会有姐妹已入宫），但主要核心都是围绕着宫斗任务展开，玩法会略有不同。）
    <br>
    2.选完身份后，本游戏将会为你构建一个专属世界，待构建完成后，可以点击人物志查看主要人物（目前仅支持查看皇帝、各个妃嫔和自己的信息，妃嫔可以点击姓名查看详情）。
    <br>
    3.秀女的首要任务是度过一个月教习期，目前教习期功能较为简陋，作用是可以补充属性（若你容貌过低，可以通过执行容貌相关的活动加减）。
    <br>
    4.教习期完成后参加殿选，殿选最终的位份影响因素很多，主要根据性格、各项属性和皇帝喜好来判断。
    <br>
    5.殿选完成后，便可以进入宫廷生活啦~宫廷生活的玩法则是点击你想去的地方，大模型会根据近期发生的事件和人物关系自动推演，并让你做出抉择。不同的抉择将会有不同的加成效果。
    <br>
    6.游戏的目标则是尽可能的获得圣宠（毕竟还要靠它晋升嘛~），达到高位。
    <br>
    7.目前的结局触发条件为：（1）登上后位（2）打入冷宫/贬为庶人（3）连续多个月失势（4）健康值降到0触发死亡
    <br>
    （PS：目前我还没玩到结局，所以结局判定这一环的逻辑还没验证，可能有bug，等我试验过了会修，欢迎反馈）
    <br><br>
    <b>注意事项：</b>
    <br>
    1.天机演算为大模型生成过程，时间较长，麻烦各位娘娘耐心等待。（后续一定会修这个Bug）
    <br>
    2.进入宫廷生活后切记要点存档，每次退出游戏后也要点存档！！不然游戏进度不会保存
    <br><br>
    大概就是这么多啦~有什么创意或者想法或者想玩的都可以告诉我，欢迎骚扰~如果要是给我钱的话，我也不介意。
                </div>
                <!-- 更新日记内容 -->
                <div id="update" class="tab-content hidden">
                    <p class="text-base md:text-sm font-bold text-[#8B4513]">2026年1月4日</p>
                    <p class="mt-2">核心游戏逻辑搭建完成，修复手机端显示问题，修复月终总结触发逻辑问题。</p>
                    <p class="text-base md:text-sm font-bold text-[#8B4513]">2026年1月4日</p>
                    <p class="mt-2">优化剧情生成功能与月终总结功能，新增自动存档功能。</p>
                    <p class="text-base md:text-sm font-bold text-[#8B4513]">2026年1月5日</p>
                    <p class="mt-2">优化六宫地点选项玩法，新增妃嫔权势变动、人物家世显示，新增资历显示。</p>
                    <p class="text-base md:text-sm font-bold text-[#8B4513]">2026年1月6日</p>
                    <p class="mt-2">优化养心殿玩法（这真是个巨大的工程，可能还有点bug，等我试验一下再修）。</p>
                    <p class="text-base md:text-sm font-bold text-[#8B4513]">2026年1月7日</p>
                    <p class="mt-2">养心殿玩法基本优化完毕，但进入养心殿内部的互动尚未仔细打磨，可能略显粗糙。优化太医院玩法，新增太医列表，可以与太医进行相关互动。已拉拢的太医功能尚未实装，后续将开放亲信系统和下毒系统，太医将会发挥作用。</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 左上角常驻按钮 - 关闭弹窗后显示，点击重新打开 -->
    <button id="gameGuideBtn" onclick="openGameGuide()" class="fixed top-4 left-4 z-9998 bg-[#3e1f1f] text-[#f3e5ab] px-3 py-2 rounded-full border-2 border-[#8B4513] shadow-xl font-bold text-xs md:text-[10px] hover:scale-105 transition hidden">
        📖 游戏须知
    </button>
    <!-- 自动存档成功提示 -->
    <div id="autoSaveTip">✅ 已自动存档至【5号档位】</div>
    <!-- ======== 弹窗代码结束 ========= -->

    <!-- 主游戏容器 - 仅优化适配属性，保留你所有原有样式，手机端不压缩内容 -->
    <div id="game-container" class="w-full max-w-2xl bg-silk shadow-2xl rounded-lg overflow-hidden border-[6px] border-[#3e1f1f] relative min-h-[85vh] max-h-[90vh] flex flex-col mx-auto box-border">
        
        <!-- 装饰性边框 -->
        <div class="absolute inset-0 border-2 border-[#bfa76f] m-1 pointer-events-none rounded-sm z-50 opacity-50"></div>

        <!-- 标题区域 -->
        <div class="pt-8 pb-4 relative z-10 text-center bg-gradient-to-b from-[#f4f1ea] to-transparent">
            <h1 id="title" class="text-5xl font-ancient text-[#8B0000] drop-shadow-sm tracking-widest">后宫浮生记</h1>
            <div class="w-32 h-1 bg-gradient-to-r from-transparent via-[#8B0000] to-transparent mx-auto mt-2 opacity-50"></div>
        </div>

        <!-- 内容滚动区 - 核心适配：手机端放大字体+宽松排版，电脑端正常，必改！ -->
        <div id="content-scroll" class="flex-grow overflow-y-auto px-5 md:px-6 pb-40 pt-5 relative z-10 scroll-smooth text-lg md:text-sm leading-loose md:leading-relaxed">
            
            <!-- 1. 选择身份 (增加了游戏介绍) -->
            <div id="step-identity" class="space-y-6 animate-fade-in py-4">
                <!-- 游戏介绍面板 -->
                <div class="bg-[#fcfaf2] border-2 border-[#d6cbb0] p-5 rounded-lg shadow-inner text-stone-800 text-sm leading-relaxed text-justify">
                    <h3 class="text-center font-bold text-[#8B0000] mb-3 text-lg font-ancient">【 宫廷指南 】</h3>
                    <p class="mb-2">🌸 <span class="font-bold">身世随机</span>：出身高门或小家碧玉，性格温婉或骄矜，皆由天定。</p>
                    <p class="mb-2">📈 <span class="font-bold">属性养成</span>：容貌、才情、心机...通过日常教习与宫廷事件，决定你的晋升之路。</p>
                    <p class="mb-2">🎲 <span class="font-bold">AI 演义</span>：每一段剧情、每一位妃嫔的反应均由大模型实时生成，结局千变万化。</p>
                    <div class="mt-3 text-xs text-[#8B4513] text-center bg-[#f3e5ab]/30 p-2 rounded">
                        ⚠️ 提示：部分操作需要等待AI生成，请耐心候旨。
                    </div>
                </div>

                <div class="text-center mt-8">
                    <p class="text-stone-700 text-lg italic font-ancient mb-6">" 选秀在即，小主准备好入宫了吗？ "</p>
                    <div class="grid grid-cols-1 gap-4 max-w-xs mx-auto">
                        <button onclick="selectIdentity('秀女')" class="btn-palace py-4 text-xl shadow-lg border-b-4 border-[#5c1c1c]">🌷 开启秀女之路</button>
                        <button disabled class="btn-palace py-4 text-xl opacity-60 bg-gray-500 border-gray-600">🧹 宫女 (暂未开放)</button>
                    </div>
                </div>
            </div>

            <!-- 2. 选择性格 -->
            <div id="step-personality" class="hidden space-y-8 py-6 animate-slide-up">
                <p class="text-stone-800 text-center text-lg font-medium">你本是家中娇客，性情如何？</p>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    <button onclick="selectPersonality('温婉')" class="btn-palace">温婉娴静</button>
                    <button onclick="selectPersonality('娇俏')" class="btn-palace">娇俏灵动</button>
                    <button onclick="selectPersonality('天真')" class="btn-palace">天真烂漫</button>
                    <button onclick="selectPersonality('妩媚')" class="btn-palace">妩媚动人</button>
                    <button onclick="selectPersonality('骄矜')" class="btn-palace">高傲骄矜</button>
                    <button onclick="selectPersonality('清冷')" class="btn-palace">清冷孤傲</button>
                </div>
            </div>

            <!-- 3. 选秀培训环节 -->
            <div id="step-training" class="hidden space-y-5 animate-fade-in">
                <div class="bg-[#fcfaf2] p-4 border-l-4 border-[#8B0000] shadow-sm flex justify-between items-center rounded-r">
                    <div>
                        <p class="font-bold text-[#8B0000] text-lg font-ancient">入宫教习期</p>
                        <p class="text-xs text-stone-500">临阵磨枪，不快也光</p>
                    </div>
                    <div class="text-right">
                         <span class="text-xs text-stone-500">剩余行动点</span>
                         <div class="text-2xl font-bold text-[#8B0000]"><span id="training-ap">5</span>/5</div>
                    </div>
                </div>
                
                <div id="training-options" class="grid grid-cols-2 gap-3 text-sm">
                    <button onclick="doTraining('灵泉沐浴', '容貌')" class="btn-palace py-2">🛁 灵泉沐浴 (容貌)</button>
                    <button onclick="doTraining('晨起慢跑', '健康')" class="btn-palace py-2">🏃‍♀️ 晨起慢跑 (健康)</button>
                    <button onclick="doTraining('午后小憩', '体力')" class="btn-palace py-2">🛏️ 午后小憩 (体力)</button>
                    <button onclick="doTraining('研读宫规', '心机')" class="btn-palace py-2">📚 研读宫规 (心机)</button>
                    <button onclick="doTraining('临摹字帖', '才情')" class="btn-palace py-2">✍️ 临摹字帖 (才情)</button>
                    <button onclick="doTraining('练习琴曲', '乐器')" class="btn-palace py-2">🎵 练习琴曲 (乐器)</button>
                    <button onclick="doTraining('习舞舒筋', '舞艺')" class="btn-palace py-2">💃 习舞舒筋 (舞艺)</button>
                    <button onclick="doTraining('穿针引线', '绣艺')" class="btn-palace py-2">🧵 穿针引线 (绣艺)</button>
                    <button onclick="doTraining('辨识百草', '医术')" class="btn-palace py-2">🌿 辨识百草 (医术)</button>
                    <button onclick="doTraining('钻研茶点', '厨艺')" class="btn-palace py-2">🍵 钻研茶点 (厨艺)</button>
                </div>
                
                <div id="training-log" class="bg-white/50 p-4 h-32 overflow-y-auto rounded border border-[#d6cbb0] text-sm space-y-1 shadow-inner font-serif text-stone-800">
                    <p class="text-stone-400 italic">请选择今日的教习内容...</p>
                </div>
                <button id="to-palace-btn" onclick="startPalaceSelection()" class="hidden w-full btn-palace py-3 text-lg shadow-xl animate-pulse">👑 前往殿选</button>
            </div>

            <!-- 4. 殿选/剧情展示 -->
            <div id="step-story" class="hidden space-y-4 text-sm leading-relaxed text-stone-800 animate-slide-up">
                <div id="story-text" class="bg-[#fcfaf2] p-6 rounded shadow-md border border-[#d6cbb0] min-h-[350px] // text-justify font-serif"></div>
                <!-- 剧情文本核心区 - 手机端字体放大，必加！ -->
                <div id="story-text" class="w-full py-2 text-lg md:text-base leading-relaxed md:leading-normal">
                    <!-- 你的剧情文字内容 -->
                </div>
                <div id="story-footer"></div>
            </div>

            <!-- 5.等待其余秀女殿选 -->
            <div id="step-waiting" class="hidden space-y-6 py-6">
                <div class="text-center">
                    <h2 class="text-2xl font-ancient text-[#8B0000] mb-4">殿选进行中</h2>
                    <p class="text-stone-600 mb-6 italic">其余秀女正在接受殿选，请稍候...</p>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div id="candidate-1" class="border-2 border-[#d6cbb0] bg-white/50 rounded-lg p-4 text-center animate-pulse"><div class="text-sm font-bold text-stone-700">秀女甲</div><div class="text-xs text-stone-500 mt-2">面圣中...</div></div>
                    <div id="candidate-2" class="border-2 border-[#d6cbb0] bg-white/50 rounded-lg p-4 text-center animate-pulse"><div class="text-sm font-bold text-stone-700">秀女乙</div><div class="text-xs text-stone-500 mt-2">面圣中...</div></div>
                    <div id="candidate-3" class="border-2 border-[#d6cbb0] bg-white/50 rounded-lg p-4 text-center animate-pulse"><div class="text-sm font-bold text-stone-700">秀女丙</div><div class="text-xs text-stone-500 mt-2">面圣中...</div></div>
                    <div id="candidate-4" class="border-2 border-[#d6cbb0] bg-white/50 rounded-lg p-4 text-center animate-pulse"><div class="text-sm font-bold text-stone-700">秀女丁</div><div class="text-xs text-stone-500 mt-2">面圣中...</div></div>
                </div>
                <div id="waiting-results" class="space-y-4 hidden"></div>
                <div id="waiting-footer" class="hidden">
                    <button onclick="enterMainGameDirectly()" class="w-full btn-palace py-3">🚪 进入后宫生活</button>
                </div>
            </div>

            <!-- 6. 事件等待界面 -->
            <div id="step-event" class="hidden space-y-6 animate-slide-up">
                <!-- 顶部信息栏 -->
                <div class="bg-gradient-to-r from-[#3e1f1f] to-[#5c1c1c] text-[#f3e5ab] p-3 rounded shadow-lg border-b-2 border-[#DAA520] flex justify-between items-center">
                    <div>
                        <span class="text-lg mr-2">📍</span>
                        <span id="event-location-name" class="font-bold text-lg">地点</span>
                        <span class="text-xs opacity-75 ml-2">(<span id="event-player-name"></span> | <span id="event-player-rank"></span>)</span>
                    </div>
                    <div class="text-right font-ancient">
                        第<span id="event-year" class="text-lg"></span>年 <span id="event-month"></span>月
                    </div>
                </div>

                <!-- 事件标题 -->
                <div class="text-center py-2">
                    <h2 id="event-main-title" class="text-3xl font-ancient text-[#8B0000]">宫中记事</h2>
                    <p id="event-sub-title" class="text-xs text-stone-500 mt-1 tracking-widest">- 世事如棋 乾坤莫测 -</p>
                </div>

                <!-- 事件内容展示区 -->
                <div class="bg-[#fcfaf2] p-6 rounded shadow-inner border border-[#d6cbb0] min-h-[300px] max-h-[400px] overflow-y-auto relative">
                    <div id="event-description" class="text-stone-800 text-sm leading-loose text-justify font-serif space-y-4"></div>
                    <!-- 内部加载占位 -->
                    <div id="event-loading" class="flex flex-col items-center justify-center py-10 absolute inset-0 bg-white/80 z-10">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-[#8B0000] mb-2"></div>
                        <p class="text-sm text-stone-500">正在生成事件...</p>
                    </div>
                </div>

                <!-- 属性变动预览 -->
                <div id="event-preview" class="hidden bg-blue-50 border border-blue-200 rounded p-4">
                    <div id="preview-changes" class="grid grid-cols-2 gap-2 text-xs"></div>
                </div>

                <!-- 玩家选项 -->
                <div id="event-choices" class="hidden space-y-3">
                    <h4 class="font-bold text-[#8B0000] text-sm flex items-center"><span class="mr-2">⚡</span>请做出抉择：</h4>
                    <div id="choice-buttons" class="grid gap-3"></div>
                </div>

                <!-- 事件结果 -->
                <div id="event-result" class="hidden space-y-4">
                    <div id="result-changes" class="bg-[#f0fdf4] border border-green-200 rounded p-4 shadow-sm">
                        <h4 class="font-bold text-green-800 mb-2 text-sm text-center border-b pb-1">因果变动</h4>
                        <div id="result-changes-grid" class="grid grid-cols-2 gap-2 text-xs"></div>
                    </div>
                </div>

                <!-- 底部按钮 -->
                <div id="event-footer" class="space-y-3">
                    <button onclick="continueEvent()" id="event-continue-btn" class="hidden w-full btn-palace py-3">继续</button>
                    <button onclick="finishEvent()" id="event-finish-btn" class="hidden w-full btn-palace py-3 bg-[#4a4a4a] border-gray-600">↩️ 返回主界面</button>
                </div>
            </div>

            <!-- 7. 正式游戏主界面 -->
            <div id="main-game-screen" class="hidden space-y-6 animate-fade-in">
                <!-- 顶部状态栏 -->
                <div class="bg-[#2d1b1b] text-[#f3e5ab] p-4 rounded-lg shadow-lg border-2 border-[#5c3a3a] relative">
                    <!-- 第一行：基本信息与时间 -->
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-3 border-b border-[#5c3a3a] pb-2 gap-2">
                        <!-- 左侧：玩家信息 -->
                        <div class="flex items-baseline gap-2 flex-grow">
                            <span id="ui-player-name" class="text-xl font-ancient text-[#DAA520]">玩家名</span>
                            <span id="ui-player-rank" class="text-xs bg-[#8B0000] px-2 py-0.5 rounded">位份</span>
                            <span id="ui-player-grade" class="text-xs text-stone-400">品级</span>
                        </div>

                        <!-- 右侧：时间与功能按钮容器 -->
                        <div class="flex items-center gap-4 w-full md:w-auto justify-between md:justify-end">
                            <!-- 时间显示 -->
                            <div class="font-ancient text-lg text-right">
                                第 <span id="ui-year" class="text-[#DAA520]">1</span> 年 <span id="ui-month">1</span> 月
                            </div>

                            <!-- 功能按钮组 (不再悬浮，独立占位) -->
                            <div class="flex gap-2">
                                <button onclick="saveGame()" class="bg-[#4a5568] hover:bg-[#2d3748] text-white text-xs px-3 py-1.5 rounded border border-gray-600 shadow transition-all active:scale-95 flex items-center gap-1">
                                    <span>💾</span> 存
                                </button>
                                <button onclick="resetGame()" class="bg-[#742a2a] hover:bg-[#9b2c2c] text-white text-xs px-3 py-1.5 rounded border border-red-900 shadow transition-all active:scale-95 flex items-center gap-1">
                                    <span>🔄</span> 重
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 第二行：数值属性 -->
                    <div class="flex justify-around text-sm">
                        <div class="text-center"><span class="block text-xs text-stone-400">体力</span><span id="ui-stamina" class="font-bold text-green-400">100</span></div>
                        <div class="text-center"><span class="block text-xs text-stone-400">健康</span><span id="ui-health" class="font-bold text-green-400">100</span></div>
                        <div class="text-center border-l border-[#5c3a3a] pl-4"><span class="block text-xs text-[#DAA520]">行动点</span><span class="font-bold text-white"><span id="ui-action-points">5</span>/5</span></div>
                    </div>

                    <!-- 选秀通知 -->
                    <div id="draft-notification" class="hidden mt-3 bg-[#744210] border border-[#B7791F] p-2 rounded flex justify-between items-center animate-pulse">
                        <span class="text-xs text-[#FBD38D] font-bold">🎉 三年大选进行中</span>
                        <button onclick="showDraftResults()" class="bg-[#975A16] hover:bg-[#744210] text-white text-xs px-2 py-0.5 rounded">查看名录</button>
                    </div>
                </div>

                <!-- 地点选择网格 -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <button onclick="visitHeartRoom()" class="btn-palace py-5 flex flex-col items-center gap-1 group">
                        <span class="text-2xl group-hover:scale-110 transition">🐉</span>
                        <span class="text-lg font-ancient">养心殿</span>
                        <span class="text-[10px] opacity-60">面圣争宠</span>
                    </button>
                    <button onclick="visitLocation('御书房')" class="btn-palace py-5 flex flex-col items-center gap-1 group">
                        <span class="text-2xl group-hover:scale-110 transition">📚</span><span class="text-lg font-ancient">御书房</span><span class="text-[10px] opacity-60">红袖添香</span>
                    </button>
                    <button onclick="visitLocation('慈宁宫')" class="btn-palace py-5 flex flex-col items-center gap-1 group">
                        <span class="text-2xl group-hover:scale-110 transition">📿</span><span class="text-lg font-ancient">慈宁宫</span><span class="text-[10px] opacity-60">请安太后</span>
                    </button>
                    <button onclick="visitSixPalaces()" class="btn-palace py-5 flex flex-col items-center gap-1 group">
                        <span class="text-2xl group-hover:scale-110 transition">🏮</span><span class="text-lg font-ancient">六宫</span><span class="text-[10px] opacity-60">拜访妃嫔</span>
                    </button>
                    <button onclick="visitLocation('御花园')" class="btn-palace py-5 flex flex-col items-center gap-1 group">
                        <span class="text-2xl group-hover:scale-110 transition">🌺</span><span class="text-lg font-ancient">御花园</span><span class="text-[10px] opacity-60">偶遇闲逛</span>
                    </button>
                    <button onclick="visitHospital()" class="btn-palace py-5 flex flex-col items-center gap-1 group">
                        <span class="text-2xl group-hover:scale-110 transition">💊</span>
                        <span class="text-lg font-ancient">太医院</span>
                        <span class="text-[10px] opacity-60">求医问药</span>
                    </button>
                    <button onclick="visitLocation('尚宫局')" class="btn-palace py-5 flex flex-col items-center gap-1 group">
                        <span class="text-2xl group-hover:scale-110 transition">🧵</span><span class="text-lg font-ancient">尚宫局</span><span class="text-[10px] opacity-60">磨练技艺</span>
                    </button>
                    <button onclick="passMonth()" class="btn-palace py-5 flex flex-col items-center gap-1 bg-[#1a365d] border-[#2c5282] hover:bg-[#2c5282] group">
                        <span class="text-2xl group-hover:scale-110 transition">🌙</span><span class="text-lg font-ancient">安歇</span><span class="text-[10px] opacity-60">结束本月</span>
                    </button>
                </div>

                <!-- 本月事件记录 -->
                <div class="mt-4 bg-[#fcfaf2] border border-[#d6cbb0] rounded p-4 shadow-sm">
                    <h3 class="text-sm font-bold text-[#8B0000] mb-2 border-b border-[#d6cbb0] pb-1">📜 本月起居注</h3>
                    <div id="month-events" class="text-xs text-stone-600 space-y-1 max-h-32 overflow-y-auto font-serif"></div>
                </div>
            </div>

            <!-- 8. 月终总结界面 -->
            <div id="step-summary" class="hidden space-y-6 animate-fade-in pb-10">
                <!-- 顶部信息栏 -->
                <div class="text-center py-4 border-b-2 border-[#8B0000]/20">
                    <h2 class="text-3xl font-ancient text-[#8B0000]">月终考评</h2>
                    <p class="text-stone-500 text-sm mt-1">第 <span id="summary-year"></span> 年 <span id="summary-month"></span> 月</p>
                </div>

                <!-- 加载状态 -->
                <div id="summary-loading" class="flex flex-col items-center justify-center py-12">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-[#8B0000] mb-4"></div>
                    <p class="text-lg text-[#8B0000] font-bold font-ancient">内务府核算中...</p>
                    <div class="mt-6 w-64 bg-stone-200 rounded-full h-2 overflow-hidden">
                        <div id="summary-progress" class="bg-[#8B0000] h-2 rounded-full w-0 transition-all duration-500"></div>
                    </div>
                </div>

                <!-- 总结内容 -->
                <div id="summary-content" class="hidden space-y-8">
                    <div id="summary-events" class="bg-white/60 p-4 rounded shadow-sm border border-[#d6cbb0]"></div>
                    <div id="summary-bedchamber" class="bg-white/60 p-4 rounded shadow-sm border border-[#d6cbb0]"></div>
                    <div id="summary-ranks" class="bg-white/60 p-4 rounded shadow-sm border border-[#d6cbb0]"></div>
                    <div id="summary-rewards" class="bg-white/60 p-4 rounded shadow-sm border border-[#d6cbb0]"></div>
                    <div id="summary-elimination"></div> <!-- 消亡名单容器 -->

                    <div id="summary-ending" class="hidden bg-[#2d1b1b] text-[#f3e5ab] p-6 rounded shadow-xl border-2 border-[#DAA520] text-center">
                        <div id="ending-content"></div>
                    </div>

                    <div class="bg-[#fcfaf2] p-4 rounded shadow-inner border border-[#d6cbb0] text-center">
                        <div class="text-[#8B0000] font-bold mb-2 font-ancient text-lg">史官评语</div>
                        <div id="summary-comment" class="italic text-stone-700 font-serif"></div>
                    </div>

                    <div class="pt-6 text-center">
                        <button onclick="closeSummary()" class="btn-palace px-10 py-3 text-lg shadow-xl">🌅 开启下月</button>
                    </div>
                </div>
            </div>
            <!-- 9. 六宫妃嫔选择界面 -->
            <div id="step-six-palaces-select" class="hidden space-y-6 animate-fade-in">
                <!-- 顶部信息栏 -->
                <div class="bg-gradient-to-r from-[#3e1f1f] to-[#5c1c1c] text-[#f3e5ab] p-3 rounded shadow-lg border-b-2 border-[#DAA520] flex justify-between items-center">
                    <div>
                        <span class="text-lg mr-2">🌸</span>
                        <span class="font-bold text-lg">六宫</span>
                        <span class="text-xs opacity-75 ml-2">请选择要拜访的妃嫔</span>
                    </div>
                    <button onclick="backToMainGame()" class="text-[#f3e5ab] hover:text-white text-xs bg-[#8B4513] px-2 py-1 rounded">← 返回</button>
                </div>

                <!-- 妃嫔列表（滑块控制） -->
                <div class="relative">
                    <div id="concubine-list" class="flex space-x-3 overflow-x-auto pb-4 px-1" style="scrollbar-width: thin;">
                        <!-- 妃嫔卡片将通过JS动态生成 -->
                    </div>
                    <!-- 左右滚动提示 -->
                    <div class="flex justify-center mt-2 text-xs text-stone-500">
                        <span>← 左右滑动查看更多 →</span>
                    </div>
                </div>

                <!-- 分隔线 -->
                <div class="border-t border-[#d6cbb0] my-4"></div>

                <!-- 随机拜访选项 -->
                <div class="text-center">
                    <button onclick="selectRandomVisit()" class="w-full btn-palace py-3 text-lg">
                        🚶‍♀️ 随意逛逛
                    </button>
                    <p class="text-xs text-stone-500 mt-2">随机拜访一位妃嫔</p>
                </div>
            </div>

            <!-- 10. 六宫互动方式选择界面 -->
            <div id="step-six-interaction" class="hidden space-y-6 animate-fade-in">
                <!-- 顶部信息栏 -->
                <div class="bg-gradient-to-r from-[#3e1f1f] to-[#5c1c1c] text-[#f3e5ab] p-3 rounded shadow-lg border-b-2 border-[#DAA520] flex justify-between items-center">
                    <div>
                        <span class="text-lg mr-2">🌸</span>
                        <span id="interaction-target-name" class="font-bold text-lg">妃嫔姓名</span>
                        <span class="text-xs opacity-75 ml-2">请选择互动方式</span>
                    </div>
                    <button onclick="backToConcubineSelect()" class="text-[#f3e5ab] hover:text-white text-xs bg-[#8B4513] px-2 py-1 rounded">← 更换人选</button>
                </div>

                <!-- 目标妃嫔信息卡 -->
                <div id="target-concubine-card" class="bg-[#fcfaf2] border-2 border-[#d6cbb0] rounded-lg p-4 shadow-sm">
                    <div class="grid grid-cols-2 gap-3 text-center">
                        <div><span class="block text-xs text-stone-400">位分</span><span id="target-rank" class="font-bold text-[#8B0000]">位分</span></div>
                        <div><span class="block text-xs text-stone-400">性格</span><span id="target-personality" class="font-bold">性格</span></div>
                        <div><span class="block text-xs text-stone-400">权势</span><span id="target-power" class="font-bold">权势</span></div>
                        <div><span class="block text-xs text-stone-400">好感</span><span id="target-favor" class="font-bold">好感</span></div>
                    </div>
                </div>

                <!-- 互动方式选择 -->
                <div class="space-y-4">
                    <button onclick="selectInteraction('friendly')" class="w-full btn-palace py-4 text-center border-green-600 hover:bg-green-900">
                        <div class="text-2xl mb-1">🤝</div>
                        <div class="font-bold">友好问安</div>
                        <div class="text-xs opacity-75 mt-1">以礼相待，增进好感</div>
                    </button>

                    <button onclick="selectInteraction('casual')" class="w-full btn-palace py-4 text-center border-blue-600 hover:bg-blue-900">
                        <div class="text-2xl mb-1">💬</div>
                        <div class="font-bold">随意闲聊</div>
                        <div class="text-xs opacity-75 mt-1">闲聊家常，无甚特别</div>
                    </button>

                    <button onclick="selectInteraction('sarcastic')" class="w-full btn-palace py-4 text-center border-red-600 hover:bg-red-900">
                        <div class="text-2xl mb-1">😏</div>
                        <div class="font-bold">冷嘲热讽</div>
                        <div class="text-xs opacity-75 mt-1">言语交锋，可能结怨</div>
                    </button>

                    <button onclick="selectInteraction('consulted')" class="w-full btn-palace py-4 text-center border-yellow-600 hover:bg-yellow-900">
                        <div class="text-2xl mb-1">📚</div>
                        <div class="font-bold">请教技艺</div>
                        <div class="text-xs opacity-75 mt-1">虚心请教，精进技艺</div>
                    </button>

                    <button onclick="selectInteraction('ask_for_favor')" class="w-full btn-palace py-4 text-center border-pink-600 hover:bg-pink-900">
                        <div class="text-2xl mb-1">🙏</div>
                        <div class="font-bold">请求美言</div>
                        <div class="text-xs opacity-75 mt-1">博取圣宠，暗藏危机</div>
                    </button>
                </div>
            </div>

            <!-- 11. 养心殿求见随机事件界面 -->
            <div id="step-heartroom-request" class="hidden space-y-6 animate-fade-in">
                <!-- 顶部信息栏 -->
                <div class="bg-gradient-to-r from-[#3e1f1f] to-[#5c1c1c] text-[#f3e5ab] p-3 rounded shadow-lg border-b-2 border-[#DAA520] flex justify-between items-center">
                    <div>
                        <span class="text-lg mr-2">🐉</span>
                        <span class="font-bold text-lg">养心殿求见</span>
                        <span class="text-xs opacity-75 ml-2">(<span id="heartroom-player-rank"></span>求见中)</span>
                    </div>
                    <button onclick="backToMainGameFromHeartroom()" class="text-[#f3e5ab] hover:text-white text-xs bg-[#8B4513] px-2 py-1 rounded">← 返回</button>
                </div>

                <!-- 随机事件描述 -->
                <div class="bg-[#fcfaf2] p-5 rounded shadow-inner border border-[#d6cbb0] min-h-[200px]">
                    <div id="heartroom-event-description" class="text-stone-800 text-sm leading-loose text-justify font-serif space-y-3"></div>
                    <div id="heartroom-loading" class="flex flex-col items-center justify-center py-10 absolute inset-0 bg-white/80 z-10">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-[#8B0000] mb-2"></div>
                        <p class="text-sm text-stone-500">正在生成求见事件...</p>
                    </div>
                </div>

                <!-- 玩家选项 -->
                <div id="heartroom-choices" class="hidden space-y-3">
                    <h4 class="font-bold text-[#8B0000] text-sm flex items-center"><span class="mr-2">⚡</span>请做出选择：</h4>
                    <div id="heartroom-choice-buttons" class="grid gap-3"></div>
                </div>

                <!-- 求见结果 -->
                <div id="heartroom-result" class="hidden space-y-4">
                    <div class="bg-[#f0fdf4] border border-green-200 rounded p-4 shadow-sm">
                        <h4 class="font-bold text-green-800 mb-2 text-sm text-center border-b pb-1">求见结果</h4>
                        <div id="heartroom-result-description" class="text-sm text-stone-700 mb-3"></div>
                        <div id="heartroom-result-changes" class="grid grid-cols-2 gap-2 text-xs"></div>
                    </div>
                </div>

                <!-- 进入养心殿按钮（求见成功时显示） -->
                <button id="enter-heartroom-btn" onclick="enterHeartroom()" class="hidden w-full btn-palace py-3 text-lg">🚪 进入养心殿</button>

                <!-- 返回按钮（求见失败时显示） -->
                <button id="heartroom-back-btn" onclick="backToMainGameFromHeartroom()" class="hidden w-full btn-palace py-3 bg-gray-700">↩️ 返回主界面</button>
            </div>

            <!-- 12. 养心殿内部互动界面 -->
            <div id="step-heartroom-inside" class="hidden space-y-6 animate-fade-in">
                <!-- 顶部信息栏 -->
                <div class="bg-gradient-to-r from-[#3e1f1f] to-[#5c1c1c] text-[#f3e5ab] p-3 rounded shadow-lg border-b-2 border-[#DAA520] flex justify-between items-center">
                    <div>
                        <span class="text-lg mr-2">🐉</span>
                        <span class="font-bold text-lg">养心殿内</span>
                        <span class="text-xs opacity-75 ml-2">面见圣上</span>
                    </div>
                </div>

                <!-- 当前情景描述 -->
                <div class="bg-yellow-50 border border-yellow-200 rounded p-4">
                    <h4 class="font-bold text-yellow-800 mb-2">当前情景</h4>
                    <div id="heartroom-inside-context" class="text-sm text-stone-700"></div>
                </div>

                <!-- 互动选项 -->
                <div class="space-y-4">
                    <h4 class="font-bold text-[#8B0000] text-lg text-center">请选择如何与皇上互动</h4>
                    <div id="heartroom-inside-options" class="grid gap-3">
                        <!-- 选项将通过JS动态生成 -->
                    </div>
                </div>

                <!-- 加载状态 -->
                <div id="heartroom-inside-loading" class="flex flex-col items-center justify-center py-10">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-[#8B0000] mb-2"></div>
                    <p class="text-sm text-stone-500">正在生成互动结果...</p>
                </div>

                <!-- 最终结果 -->
                <div id="heartroom-inside-result" class="hidden space-y-4">
                    <div class="bg-[#fcfaf2] p-6 rounded shadow-inner border border-[#d6cbb0]">
                        <div id="heartroom-inside-result-description" class="text-stone-800 text-sm leading-loose"></div>
                    </div>
                    <div class="bg-[#f0fdf4] border border-green-200 rounded p-4 shadow-sm">
                        <h4 class="font-bold text-green-800 mb-2 text-sm text-center border-b pb-1">结果影响</h4>
                        <div id="heartroom-inside-result-changes" class="grid grid-cols-2 gap-2 text-xs"></div>
                    </div>
                    <button onclick="finishHeartroomEvent()" class="w-full btn-palace py-3">✅ 完成</button>
                </div>
            </div>

            <!-- 13. 太医院互动主界面 -->
            <div id="step-hospital-main" class="hidden space-y-6 animate-fade-in">
                <!-- 顶部信息栏 -->
                <div class="bg-gradient-to-r from-[#1e3a2f] to-[#2d553f] text-[#f3e5ab] p-3 rounded shadow-lg border-b-2 border-[#4CAF50] flex justify-between items-center">
                    <div>
                        <span class="text-lg mr-2">💊</span>
                        <span class="font-bold text-lg">太医院</span>
                        <span class="text-xs opacity-75 ml-2">医术养生之地</span>
                    </div>
                    <button onclick="backToMainGameFromHospital()" class="text-[#f3e5ab] hover:text-white text-xs bg-[#2E7D32] px-2 py-1 rounded">← 返回</button>
                </div>

                <!-- 太医院简介 -->
                <div class="bg-green-50 border border-green-200 rounded p-4 text-sm text-green-800">
                    <div class="flex items-center mb-2">
                        <span class="text-lg mr-2">🌿</span>
                        <span class="font-bold">太医院指南</span>
                    </div>
                    <p class="text-xs">此处可求医问药、学习医术、结交太医。太医听命于不同主子，需谨慎行事。</p>
                </div>

                <!-- 主要功能按钮 -->
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="showDoctorList()" class="btn-palace py-5 flex flex-col items-center gap-2 bg-green-900 border-green-700 hover:bg-green-800">
                        <span class="text-2xl">👨‍⚕️</span>
                        <span class="font-bold text-lg">太医列表</span>
                        <span class="text-xs opacity-75">查看所有太医</span>
                    </button>

                    <button id="nurture-body-btn" onclick="nurtureBody()" class="btn-palace py-5 flex flex-col items-center gap-2 bg-blue-900 border-blue-700 hover:bg-blue-800">
                        <span class="text-2xl">🧘‍♀️</span>
                        <span class="font-bold text-lg">调养身体</span>
                        <span class="text-xs opacity-75">每月限一次</span>
                    </button>

                    <button onclick="learnMedicine()" class="btn-palace py-5 flex flex-col items-center gap-2 bg-purple-900 border-purple-700 hover:bg-purple-800">
                        <span class="text-2xl">📚</span>
                        <span class="font-bold text-lg">学习医术</span>
                        <span class="text-xs opacity-75">提升医术属性</span>
                    </button>

                    <button onclick="wanderHospital()" class="btn-palace py-5 flex flex-col items-center gap-2 bg-gray-800 border-gray-700 hover:bg-gray-700">
                        <span class="text-2xl">🚶‍♀️</span>
                        <span class="font-bold text-lg">随便逛逛</span>
                        <span class="text-xs opacity-75">偶遇随机事件</span>
                    </button>
                </div>

                <!-- 当前状态 -->
                <div class="bg-gray-50 border border-gray-200 rounded p-3 text-sm">
                    <div class="flex justify-between items-center">
                        <span class="font-bold text-gray-700">当前太医人数</span>
                        <span id="hospital-doctor-count" class="text-green-600 font-bold">0</span>
                    </div>
                    <div class="flex justify-between items-center mt-1">
                        <span class="text-gray-600">本月已调养</span>
                        <span id="hospital-nurtured-this-month" class="text-blue-600">否</span>
                    </div>
                    <!-- 新增：太医生成状态提示 -->
                    <div id="hospital-generating-status" class="hidden text-center text-xs text-yellow-600 mt-2">
                        ⏳ 新太医采选中，请稍候...
                    </div>
                </div>
            </div>

            <!-- 14. 太医列表界面 -->
            <div id="step-doctor-list" class="hidden space-y-6 animate-fade-in">
                <!-- 顶部信息栏 -->
                <div class="bg-gradient-to-r from-[#1e3a2f] to-[#2d553f] text-[#f3e5ab] p-3 rounded shadow-lg border-b-2 border-[#4CAF50] flex justify-between items-center">
                    <div>
                        <span class="text-lg mr-2">👨‍⚕️</span>
                        <span class="font-bold text-lg">太医名录</span>
                        <span class="text-xs opacity-75 ml-2">共<span id="doctor-count">0</span>位太医</span>
                    </div>
                    <button onclick="backToHospitalMain()" class="text-[#f3e5ab] hover:text-white text-xs bg-[#2E7D32] px-2 py-1 rounded">← 返回</button>
                </div>

                <!-- 太医列表 -->
                <div id="doctor-list-container" class="space-y-3 max-h-[400px] overflow-y-auto pr-2">
                    <!-- 太医卡片将通过JS动态生成 -->
                </div>

                <!-- 空状态提示 -->
                <div id="doctor-empty-state" class="hidden text-center py-8 text-gray-500">
                    <div class="text-4xl mb-2">🫥</div>
                    <p>暂无太医记录</p>
                    <p class="text-xs mt-1">太医选拔中...</p>
                </div>
            </div>

            <!-- 15. 太医详情界面 -->
            <div id="step-doctor-detail" class="hidden space-y-6 animate-fade-in">
                <!-- 顶部信息栏 -->
                <div class="bg-gradient-to-r from-[#1e3a2f] to-[#2d553f] text-[#f3e5ab] p-3 rounded shadow-lg border-b-2 border-[#4CAF50] flex justify-between items-center">
                    <div>
                        <span class="text-lg mr-2">👨‍⚕️</span>
                        <span id="doctor-detail-name" class="font-bold text-lg">太医姓名</span>
                        <span class="text-xs opacity-75 ml-2" id="doctor-detail-rank">品级</span>
                    </div>
                    <button onclick="backToDoctorList()" class="text-[#f3e5ab] hover:text-white text-xs bg-[#2E7D32] px-2 py-1 rounded">← 返回列表</button>
                </div>

                <!-- 太医详细信息 -->
                <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div class="text-center">
                            <div class="text-xs text-gray-500">年龄</div>
                            <div id="doctor-age" class="font-bold text-lg">--</div>
                        </div>
                        <div class="text-center">
                            <div class="text-xs text-gray-500">性格</div>
                            <div id="doctor-personality" class="font-bold text-lg">--</div>
                        </div>
                        <div class="text-center">
                            <div class="text-xs text-gray-500">品级</div>
                            <div id="doctor-rank" class="font-bold text-lg">--</div>
                        </div>
                        <div class="text-center">
                            <div class="text-xs text-gray-500">医术值</div>
                            <div id="doctor-skill" class="font-bold text-lg text-green-600">--</div>
                        </div>
                        <div class="col-span-2 text-center">
                            <div class="text-xs text-gray-500">听命于</div>
                            <div id="doctor-serves" class="font-bold text-lg text-blue-600">--</div>
                        </div>
                    </div>

                    <div class="border-t pt-4">
                        <div class="text-xs text-gray-500 mb-1">对你好感度</div>
                        <div class="flex items-center">
                            <div id="doctor-favor" class="font-bold text-lg mr-2">0</div>
                            <div class="flex-grow h-2 bg-gray-200 rounded-full overflow-hidden">
                                <div id="doctor-favor-bar" class="h-full bg-pink-500 rounded-full" style="width: 50%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 互动选项 -->
                <div class="space-y-3">
                    <h4 class="font-bold text-[#2E7D32] text-lg text-center">选择互动方式</h4>

                    <button id="learn-from-doctor-btn" onclick="learnFromDoctor()" class="w-full btn-palace py-3 text-center bg-green-900 hover:bg-green-800">
                        <div class="font-bold">请教医术</div>
                        <div class="text-xs opacity-75">向太医学习医术知识</div>
                    </button>

                    <button id="recruit-doctor-btn" onclick="recruitDoctor()" class="w-full btn-palace py-3 text-center bg-blue-900 hover:bg-blue-800">
                        <div class="font-bold">拉拢太医</div>
                        <div class="text-xs opacity-75">尝试让太医听命于你</div>
                    </button>

                    <button id="sow-discord-btn" onclick="sowDiscord()" class="w-full btn-palace py-3 text-center bg-red-900 hover:bg-red-800">
                        <div class="font-bold">挑拨离间</div>
                        <div class="text-xs opacity-75">挑拨太医与原主子的关系</div>
                    </button>

                    <!-- 提示信息 -->
                    <div id="doctor-interaction-hint" class="hidden text-xs text-gray-500 text-center p-2 bg-gray-100 rounded">
                        <!-- 提示信息将通过JS动态设置 -->
                    </div>
                </div>
            </div>

            <!-- 16. 太医院事件界面（用于请教、拉拢、挑拨、随便逛逛的结果展示） -->
            <div id="step-hospital-event" class="hidden space-y-6 animate-fade-in">
                <!-- 顶部信息栏 -->
                <div class="bg-gradient-to-r from-[#1e3a2f] to-[#2d553f] text-[#f3e5ab] p-3 rounded shadow-lg border-b-2 border-[#4CAF50] flex justify-between items-center">
                    <div>
                        <span class="text-lg mr-2">💊</span>
                        <span id="hospital-event-title" class="font-bold text-lg">太医院事件</span>
                    </div>
                    <button onclick="backToDoctorDetail()" class="text-[#f3e5ab] hover:text-white text-xs bg-[#2E7D32] px-2 py-1 rounded">← 返回</button>
                </div>

                <!-- 事件描述 -->
                <div class="bg-[#fcfaf2] p-5 rounded shadow-inner border border-[#d6cbb0] min-h-[200px]">
                    <div id="hospital-event-description" class="text-stone-800 text-sm leading-loose text-justify font-serif space-y-3"></div>
                    <div id="hospital-loading" class="flex flex-col items-center justify-center py-10 absolute inset-0 bg-white/80 z-10">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-[#2E7D32] mb-2"></div>
                        <p class="text-sm text-stone-500">正在生成事件...</p>
                    </div>
                </div>

                <!-- 属性变动 -->
                <div id="hospital-result" class="hidden space-y-4">
                    <div class="bg-[#f0fdf4] border border-green-200 rounded p-4 shadow-sm">
                        <h4 class="font-bold text-green-800 mb-2 text-sm text-center border-b pb-1">结果影响</h4>
                        <div id="hospital-result-changes" class="grid grid-cols-2 gap-2 text-xs"></div>
                    </div>
                </div>

                <!-- 完成按钮 -->
                <button id="hospital-finish-btn" onclick="finishHospitalEvent()" class="w-full btn-palace py-3">✅ 完成</button>
            </div>
        </div>

        <!-- 底部栏 -->
        <!-- 底部栏 - 手机端按钮+文字放大适配，完美显示，保留所有原有点击事件 -->
        <div class="absolute bottom-5 left-0 right-0 z-50 flex justify-center gap-3 md:gap-4 flex-wrap pointer-events-none px-4 md:px-4">
            <button onclick="showMainMenu()" class="pointer-events-auto bg-[#2d1b1b] text-[#f3e5ab] px-6 py-4 md:px-4 md:py-2 rounded-full border-2 border-[#8B4513] shadow-xl font-bold hover:scale-105 transition text-base md:text-xs flex items-center gap-2 min-w-[90px] md:min-w-[80px]"><span>📜</span>人物志</button>
            <button onclick="showEventLog()" class="pointer-events-auto bg-[#2d1b1b] text-[#f3e5ab] px-6 py-4 md:px-4 md:py-2 rounded-full border-2 border-[#8B4513] shadow-xl font-bold hover:scale-105 transition text-base md:text-xs flex items-center gap-2 min-w-[90px] md:min-w-[80px]"><span>📖</span>事件簿</button>
            <button onclick="showLoadModal()" class="pointer-events-auto bg-[#2d1b1b] text-[#f3e5ab] px-6 py-4 md:px-4 md:py-2 rounded-full border-2 border-[#8B4513] shadow-xl font-bold hover:scale-105 transition text-base md:text-xs flex items-center gap-2 min-w-[90px] md:min-w-[80px]"><span>📂</span>读档</button>
        </div>
    </div>

    <!-- 模态框 (保持ID不变以兼容原逻辑) -->
    <div id="info-overlay" class="hidden fixed inset-0 z-[100] modal-bg flex items-center justify-center p-4">
        <div class="bg-silk w-full max-w-md max-h-[80vh] rounded-lg shadow-2xl flex flex-col border-[3px] border-[#5c3a3a] relative">
            <div class="p-4 border-b-2 border-[#d6cbb0] flex justify-between items-center bg-[#fcfaf2]">
                <h2 id="modal-title" class="font-ancient text-2xl text-[#8B0000]">标题</h2>
                <button onclick="closeModal()" class="text-stone-500 hover:text-red-900 text-3xl font-bold">&times;</button>
            </div>
            <div id="modal-body" class="p-6 overflow-y-auto flex-grow text-stone-800 text-sm font-serif"></div>
            <div class="p-4 border-t border-[#d6cbb0] bg-[#fcfaf2]">
                <button id="back-btn" class="hidden w-full bg-[#5c3a3a] hover:bg-[#3e1f1f] text-[#f3e5ab] py-2 rounded font-bold transition">返回</button>
            </div>
        </div>
    </div>

    <!-- 存档管理模态框 -->
    <div id="save-modal" class="hidden fixed inset-0 z-[300] modal-bg flex items-center justify-center p-4">
        <div class="bg-silk w-full max-w-lg max-h-[85vh] rounded-lg shadow-2xl flex flex-col border-[3px] border-[#5c3a3a] relative">
            <div class="p-4 border-b-2 border-[#d6cbb0] flex justify-between items-center bg-[#fcfaf2]">
                <h2 id="save-title" class="font-ancient text-2xl text-[#8B0000]">存档管理</h2>
                <button onclick="closeSaveModal()" class="text-stone-500 hover:text-red-900 text-3xl font-bold">&times;</button>
            </div>
            <div id="save-content" class="p-6 overflow-y-auto flex-grow text-stone-800 text-sm">
                <div id="save-slots" class="space-y-4"></div>
            </div>
            <div id="save-footer" class="p-4 border-t border-[#d6cbb0] bg-[#fcfaf2] flex justify-between items-center">
                <div class="text-xs text-stone-500">共 <span id="save-count">0</span> 个存档</div>
                <button onclick="closeSaveModal()" class="btn-palace px-6 py-1 text-sm">关闭</button>
            </div>
        </div>
    </div>
    
    <!-- 事件弹窗模态框 -->
    <div id="event-modal" class="hidden fixed inset-0 modal-bg z-[200] flex items-center justify-center p-4">
        <div class="bg-silk w-full max-w-2xl max-h-[85vh] rounded-lg shadow-2xl flex flex-col border-[3px] border-[#5c3a3a] relative">
            <div class="p-4 border-b-2 border-[#d6cbb0] flex justify-between items-center bg-[#fcfaf2]">
                <h2 id="event-title" class="font-ancient text-2xl text-[#8B0000]">宫中记事</h2>
                <button onclick="closeEventModal()" class="text-stone-500 hover:text-red-900 text-3xl font-bold">&times;</button>
            </div>
            <div id="event-content" class="p-6 overflow-y-auto flex-grow text-stone-800 text-sm leading-relaxed font-serif"></div>
            <div id="event-options" class="p-4 border-t border-[#d6cbb0] bg-[#fcfaf2] space-y-2 hidden"></div>
            <div id="event-footer-modal" class="p-4 border-t border-[#d6cbb0] bg-[#fcfaf2]">
                 <button onclick="closeEventModal()" class="w-full btn-palace py-2">朕知道了</button>
            </div>
        </div>
    </div>

    <script>
        // 位分等级映射表（与后端保持一致）
        const RANK_LEVELS = {
            // 从高到低排列
            "中宫皇后": 0,
            "正一品皇贵妃": 1,
            "从一品贵妃": 2,
            "正二品妃": 3,
            "从二品嫔": 4,
            "正三品昭仪": 5, "正三品昭容": 5, "正三品昭媛": 5,
            "从三品修仪": 6, "从三品修容": 6, "从三品修媛": 6,
            "正四品充仪": 7, "正四品充容": 7, "正四品充媛": 7,
            "从四品婕妤": 8,
            "正五品贵人": 9,
            "从五品美人": 10,
            "正六品才人": 11,
            "从六品常在": 12,
            "正七品答应": 13,
            "从七品官女子": 14
        };
        
        // === Loading 辅助函数 ===
        function showAILoading() { document.getElementById('ai-loading-overlay').classList.remove('hidden'); }
        function hideAILoading() { document.getElementById('ai-loading-overlay').classList.add('hidden'); }

        // ==========================================
        // 以下为原始逻辑代码，仅注入了 showAILoading() 
        // 核心变量、ID引用、函数逻辑完全未变
        // ==========================================

        let gameState = {
            current_year: 1,
            current_month: 1,
            action_points: 5, // 每月行动点
            events_log: [],
            identity: '秀女',
            personality: '',
            training_ap: 5,
            location_history: [], // 记录访问过的地点和事件
            new_draft_candidates: [], // 新增：用于存储本轮新入宫的秀女，以便查看
            妃嫔信息: [],  // 初始化数组
            heartroom_visits_this_month: 0, // 新增：本月养心殿求见次数
            太医列表: [] // 新增：存储太医信息
        };

        // === 1. 定义所有界面 ID 列表 ===
        const ALL_SCREENS = [
            'step-identity',      // 1. 选择身份
            'step-personality',   // 2. 选择性格
            'step-training',      // 3. 培训
            'step-story',         // 4. 剧情/殿选
            'step-waiting',       // 5. 等待结果
            'step-event',         // 6. 事件详情
            'main-game-screen',   // 7. 主游戏界面
            'step-summary',       // 8. 月终总结
            'step-six-palaces-select',  // 9. 六宫妃嫔选择
            'step-six-interaction',      // 10. 六宫互动选择
            'step-heartroom-request', // 11. 养心殿求见
            'step-heartroom-inside',   // 12. 养心殿内部
            'step-hospital-main',     // 13. 太医院主界面
            'step-doctor-list',       // 14. 太医列表
            'step-doctor-detail',     // 15. 太医详情
            'step-hospital-event'     // 16. 太医院事件
        ];

        // === 2. 通用切换屏幕函数（强力修复） ===
        function switchScreen(targetId) {
            // 隐藏所有屏幕
            ALL_SCREENS.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });

            // 只显示目标屏幕
            const target = document.getElementById(targetId);
            if (target) target.classList.remove('hidden');

            // 滚动到顶部（优化体验）
            document.getElementById('content-scroll').scrollTop = 0;
        }

        function selectIdentity(id) {
            if(id !== '秀女') return;
            document.getElementById('step-identity').classList.add('hidden');
            document.getElementById('step-personality').classList.remove('hidden');
            document.getElementById('title').innerText = "心性抉择";
        }

        async function selectPersonality(pers) {
            gameState.personality = pers;
            showAILoading(); // 【注入】显示Loading

            try {
                const response = await fetch('/start_game', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ identity: '秀女', personality: pers })
                });
                const data = await response.json();
                
                hideAILoading(); // 【注入】隐藏Loading

                if (data.success) {
                    document.getElementById('step-personality').classList.add('hidden');
                    document.getElementById('step-story').classList.remove('hidden');
                    const storyText = document.getElementById('story-text');
                    
                    // 合并数据
                    gameState = {...gameState, ...data.data};
                    // 确保玩家有资历字段，如果没有则初始化为0
                    if (!gameState.玩家详细信息.资历) {
                        gameState.玩家详细信息.资历 = "0年0月";
                    }
                    storyText.innerHTML = `<p class="font-bold text-[#8B0000] mb-2 text-center text-lg">【前尘往事】</p><p class="leading-loose">${gameState.背景介绍}</p>`;
                    // 这里只有一个按钮：前往培训期
                    document.getElementById('story-footer').innerHTML = `<button onclick="enterTraining()" class="w-full btn-palace py-3">前往培训期</button>`;
                }
            } catch (e) { 
                hideAILoading();
                alert("连接失败"); 
            }
        }

        function enterTraining() {
            document.getElementById('step-story').classList.add('hidden');
            document.getElementById('step-training').classList.remove('hidden');
            document.getElementById('title').innerText = "教习时光";
        }

        function doTraining(actionName, attrName) {
            if(gameState.training_ap <= 0) return;
            gameState.training_ap--;

            // 指向大模型生成的属性路径
            if(gameState.玩家详细信息 && gameState.玩家详细信息.各项属性) {
                gameState.玩家详细信息.各项属性[attrName] += 5;
                const newVal = gameState.玩家详细信息.各项属性[attrName];

                const log = document.getElementById('training-log');
                if(log.innerText.includes('请选择')) log.innerHTML = '';
                log.innerHTML = `<p class='text-[#8B0000] border-b border-[#d6cbb0] pb-1'>进行了【${actionName}】：${attrName}提升至 ${newVal}！</p>` + log.innerHTML;
            }

            document.getElementById('training-ap').innerText = gameState.training_ap;
            if(gameState.training_ap === 0) {
                document.getElementById('training-options').classList.add('opacity-50', 'pointer-events-none');
                document.getElementById('to-palace-btn').classList.remove('hidden');
            }
        }

        async function startPalaceSelection() {
            showAILoading(); // 【注入】

            document.getElementById('step-training').classList.add('hidden');
            document.getElementById('step-story').classList.remove('hidden');
            document.getElementById('title').innerText = "殿前大选";
            document.getElementById('story-footer').innerHTML = '';

            const storyArea = document.getElementById('story-text');
            storyArea.innerHTML = ''; 

            try {
                const response = await fetch('/start_game', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ ...gameState, is_palace_selection: true })
                });
                const data = await response.json();
                
                hideAILoading(); // 【注入】

                if(data.success) {
                    const result = data.data;
                    let displayHtml = "";

                    // 解析随机事件及好感度变动
                    if(result.殿选随机事件) {
                        result.殿选随机事件.forEach(evt => {
                            displayHtml += `<div class='mb-4 p-3 bg-white/50 border-l-4 border-[#8B0000] rounded shadow-sm'>
                                <p class='font-bold text-stone-800 mb-1'>◆ ${evt.事件描述}</p>`;

                            let impactHtml = "<div class='flex flex-wrap gap-2 mt-2'>";
                            evt.影响逻辑.forEach(logic => {
                                for(let name in logic) {
                                    const val = logic[name];
                                    if(!gameState.初始好感度信息) gameState.初始好感度信息 = {};
                                    if(gameState.初始好感度信息[name] === undefined) gameState.初始好感度信息[name] = 0;
                                    gameState.初始好感度信息[name] += val;

                                    const colorClass = val >= 0 ? 'text-green-700 bg-green-50' : 'text-red-700 bg-red-50';
                                    impactHtml += `<span class='px-2 py-0.5 rounded border ${colorClass} text-xs font-bold'>${name} ${val > 0 ? '+' : ''}${val}</span>`;
                                }
                            });
                            displayHtml += impactHtml + "</div></div>";
                        });
                    }

                    if(result.皇上好感度) {
                        gameState.初始好感度信息["皇上"] += result.皇上好感度;
                        displayHtml += `<div class='text-center mb-4'><span class='bg-[#f3e5ab] text-[#8B4513] px-3 py-1 rounded-full text-xs font-bold border border-[#DAA520]'>👑 圣宠变动：${result.皇上好感度 > 0 ? '+' : ''}${result.皇上好感度}</span></div>`;
                    }

                    const finalTitle = (result.殿选结果.封号 === "无" || !result.殿选结果.封号) ? "" : result.殿选结果.封号;
                    const finalRank = result.殿选结果.位分;
                    gameState.玩家详细信息.身份 = finalTitle + finalRank;
                    gameState.玩家详细信息.品级 = result.殿选结果.品级 || "无";

                    const timeKey = `${gameState.current_year}年${gameState.current_month}月`;
                    if(result.事件概括) {
                        result.事件概括.forEach(obj => {
                            for(let k in obj) gameState.events_log.push({ time: timeKey, content: obj[k] });
                        });
                    }

                    storyArea.innerHTML = `
                        ${displayHtml}
                        <div class="py-4 border-t border-[#d6cbb0] leading-relaxed text-stone-700 italic">
                            "${result.皇上钦定位份事件描述}"
                        </div>
                        <div class="text-center py-6 bg-[#fcfaf2] rounded-lg border-2 border-dashed border-[#8B0000]">
                            <p class="text-[#8B0000] font-bold text-sm">册封旨意</p>
                            <h3 class="text-4xl font-ancient text-[#8B0000] mt-2">${gameState.玩家详细信息.身份}</h3>
                            <p class="text-stone-500 text-xs mt-2">${gameState.玩家详细信息.姓名}，领旨谢恩——</p>
                        </div>
                    `;
                    document.getElementById('story-footer').innerHTML = `<button onclick="enterFinalGame()" class="w-full btn-palace py-3">臣妾领旨</button>`;
                }
            } catch (e) { 
                hideAILoading();
                alert("数据解析异常"); 
            }
        }

        function enterFinalGame() {
            document.getElementById('step-story').classList.add('hidden');
            document.getElementById('step-waiting').classList.remove('hidden');
            document.getElementById('title').innerText = "殿选进行中";
            generateOtherCandidates();
            setTimeout(() => { checkTriennialSelection(); }, 2000); 
        }

        function updateUI() {
            const p = gameState.玩家详细信息;
            document.getElementById('ui-player-name').innerText = p.姓名;
            document.getElementById('ui-player-rank').innerText = p.身份;
            document.getElementById('ui-player-grade').innerText = `品级：${p.品级 || "无"}`;
            document.getElementById('ui-stamina').innerText = p.各项属性.体力;
            document.getElementById('ui-health').innerText = p.各项属性.健康;
            document.getElementById('ui-year').innerText = gameState.current_year;
            document.getElementById('ui-month').innerText = gameState.current_month;
            document.getElementById('ui-action-points').innerText = gameState.action_points;

            const locationButtons = document.querySelectorAll('#main-game-screen button[onclick^="visitLocation"]');
            locationButtons.forEach(btn => {
                if (gameState.action_points <= 0) {
                    btn.disabled = true;
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            });

            const draftDiv = document.getElementById('draft-notification');
            if (gameState.new_draft_candidates && gameState.new_draft_candidates.length > 0 && gameState.current_month === 1) {
                draftDiv.classList.remove('hidden');
            } else {
                draftDiv.classList.add('hidden');
            }
        }

        async function visitLocation(locationName) {
            if (gameState.action_points <= 0) {
                alert("本月行动点已用尽，请结束本月");
                return;
            }

            document.getElementById('main-game-screen').classList.add('hidden');
            document.getElementById('step-event').classList.remove('hidden');

            document.getElementById('event-player-name').textContent = gameState.玩家详细信息.姓名;
            document.getElementById('event-player-rank').textContent = gameState.玩家详细信息.身份;
            document.getElementById('event-location-name').textContent = locationName;
            document.getElementById('event-year').textContent = gameState.current_year;
            document.getElementById('event-month').textContent = gameState.current_month;
            document.getElementById('event-main-title').textContent = `${locationName}记事`;
            document.getElementById('event-sub-title').textContent = "正在生成事件...";

            document.getElementById('event-description').innerHTML = '';
            document.getElementById('event-preview').classList.add('hidden');
            document.getElementById('event-choices').classList.add('hidden');
            document.getElementById('event-result').classList.add('hidden');
            document.getElementById('event-continue-btn').classList.add('hidden');
            document.getElementById('event-finish-btn').classList.add('hidden');
            document.getElementById('event-loading').classList.remove('hidden');

            gameState.action_points--;
            showAILoading(); // 【注入】

            try {
                const requestData = {
                    皇帝个人信息: gameState.皇帝个人信息,
                    妃嫔信息: gameState.妃嫔信息,
                    玩家详细信息: gameState.玩家详细信息,
                    初始好感度信息: gameState.初始好感度信息,
                    事件簿: gameState.events_log.slice(-10),
                    当前地点: locationName,
                    当前时间: `${gameState.current_year}年${gameState.current_month}月`,
                    剩余行动点: gameState.action_points
                };

                const response = await fetch('/generate_location_event', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(requestData)
                });

                const data = await response.json();
                hideAILoading(); // 【注入】

                if (data.success) {
                    window.currentEventData = data.event;
                    window.currentEventLocation = locationName;
                    displayEventContent(data.event);
                } else {
                    showEventError("事件生成失败，请重试");
                }
            } catch (e) {
                hideAILoading();
                showEventError("连接失败，请检查网络连接");
            }
        }

        function displayEventContent(eventData) {
            document.getElementById('event-loading').classList.add('hidden');
            document.getElementById('event-sub-title').textContent = "请做出选择";
            const descriptionDiv = document.getElementById('event-description');
            descriptionDiv.innerHTML = `<div class="space-y-3"><p class="leading-relaxed">${eventData.初始事件描述}</p></div>`;
            document.getElementById('event-preview').classList.add('hidden');
            const choicesDiv = document.getElementById('event-choices');
            const choiceButtonsDiv = document.getElementById('choice-buttons');
            choiceButtonsDiv.innerHTML = '';
            eventData.选项.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'w-full btn-palace py-3 text-sm text-left px-4';
                button.textContent = `${index+1}. ${option.选项描述}`;
                button.onclick = () => handlePlayerChoice(index);
                choiceButtonsDiv.appendChild(button);
            });
            choicesDiv.classList.remove('hidden');
        }

        function handlePlayerChoice(choiceIndex) {
            document.getElementById('event-choices').classList.add('hidden');
            document.getElementById('event-preview').classList.add('hidden');
            const selectedOption = window.currentEventData.选项[choiceIndex];
            const descriptionDiv = document.getElementById('event-description');
            descriptionDiv.innerHTML = `<div class="space-y-3"><p class="leading-relaxed animate-fade-in">${selectedOption.详细事件描述}</p></div>`;
            applyEventResult(selectedOption, true);
        }

        function applyEventResult(resultData, fromChoice = false) {
            // 如果是六宫互动，特殊处理
            if (window.currentEventLocation === '六宫' && selectedConcubine) {
                document.getElementById('event-sub-title').textContent = `对${selectedConcubine.姓名}的互动结果`;
            } else {
                document.getElementById('event-sub-title').textContent = fromChoice ? "选择结果" : "事件结果";
            }
            document.getElementById('event-sub-title').textContent = fromChoice ? "选择结果" : "事件结果";
            
            const playerAttrs = gameState.玩家详细信息.各项属性;
            const attrChanges = {}; 
            for (const attr in resultData.玩家属性变动) {
                const change = resultData.玩家属性变动[attr];
                if (playerAttrs[attr] !== undefined) {
                    playerAttrs[attr] += change;
                    playerAttrs[attr] = Math.max(0, Math.min(100, playerAttrs[attr]));
                    if (change !== 0) attrChanges[attr] = change;
                }
            }

            const favorChanges = {}; 
            if (resultData.人物好感度变动) {
                for (const person in resultData.人物好感度变动) {
                    const change = resultData.人物好感度变动[person];
                    const key = (person === "皇上" || person === gameState.皇帝个人信息.姓名) ? "皇上" : person;
                    if (gameState.初始好感度信息[key] === undefined) gameState.初始好感度信息[key] = 0;
                    gameState.初始好感度信息[key] += change;
                    if (change !== 0) favorChanges[key] = change;
                }
            }

            // ========== 新增：处理妃嫔属性变动 ==========
            const concubineAttrChanges = {}; 
            if (resultData.妃嫔属性变动 && Array.isArray(resultData.妃嫔属性变动)) {
                resultData.妃嫔属性变动.forEach(change => {
                    const { 姓名, 圣宠变动 = 0, 权势变动 = 0 } = change;

                    // 更新妃嫔信息
                    const concubine = gameState.妃嫔信息.find(c => c.姓名 === 姓名);
                    if (concubine) {
                        if (concubine.宠爱度 === undefined) concubine.宠爱度 = 0;
                        if (concubine.权势 === undefined) concubine.权势 = 0;

                        concubine.宠爱度 += 圣宠变动;
                        concubine.宠爱度 = Math.max(0, Math.min(100, concubine.宠爱度));

                        concubine.权势 += 权势变动;
                        concubine.权势 = Math.max(0, Math.min(100, concubine.权势));

                        // 记录变动
                        concubineAttrChanges[姓名] = {
                            圣宠变动: 圣宠变动,
                            权势变动: 权势变动
                        };
                    }
                });
            }
            
            const timeKey = `${gameState.current_year}年${gameState.current_month}月`;
            if (resultData.事件概括) {
                const eventLog = { time: timeKey, content: `【${window.currentEventLocation}】${resultData.事件概括}` };
                gameState.events_log.push(eventLog);
                addMonthEvent(resultData.事件概括);
            }

            const resultDiv = document.getElementById('event-result');
            const resultGrid = document.getElementById('result-changes-grid');
            let resultHtml = '';
            
            if (Object.keys(attrChanges).length > 0) {
                resultHtml += `<div class="col-span-2 text-xs font-bold text-gray-500 mb-1">自身属性</div>`;
                for (const attr in attrChanges) {
                    const change = attrChanges[attr];
                    const color = change > 0 ? 'text-green-600' : 'text-red-600';
                    resultHtml += `<div class="flex justify-between p-1 bg-white rounded border border-gray-100"><span>${attr}</span><span class="${color}">${change > 0 ? '+' : ''}${change}</span></div>`;
                }
            }
            if (Object.keys(favorChanges).length > 0) {
                resultHtml += `<div class="col-span-2 text-xs font-bold text-gray-500 mb-1 mt-2">人心变动</div>`;
                for (const person in favorChanges) {
                    const change = favorChanges[person];
                    const color = change > 0 ? 'text-pink-600' : 'text-blue-600';
                    resultHtml += `<div class="flex justify-between p-1 bg-white rounded border border-gray-100"><span>${person}</span><span class="${color}">${change > 0 ? '❤️+' : '💔'}${change}</span></div>`;
                }
            }

            // ========== 新增：显示妃嫔属性变动 ==========
            if (Object.keys(concubineAttrChanges).length > 0) {
                resultHtml += `<div class="col-span-2 text-xs font-bold text-gray-500 mb-1 mt-2">妃嫔变动</div>`;
                for (const name in concubineAttrChanges) {
                    const changes = concubineAttrChanges[name];
                    const favorColor = changes.圣宠变动 > 0 ? 'text-yellow-600' : 'text-gray-600';
                    const powerColor = changes.权势变动 > 0 ? 'text-purple-600' : 'text-gray-600';

                    // 显示圣宠变动
                    if (changes.圣宠变动 !== 0) {
                        resultHtml += `<div class="flex justify-between p-1 bg-white rounded border border-gray-100">
                            <span class="text-xs">${name}·圣宠</span>
                            <span class="${favorColor} text-xs">${changes.圣宠变动 > 0 ? '↑+' : '↓'}${changes.圣宠变动}</span>
                        </div>`;
                    }

                    // 显示权势变动
                    if (changes.权势变动 !== 0) {
                        resultHtml += `<div class="flex justify-between p-1 bg-white rounded border border-gray-100">
                            <span class="text-xs">${name}·权势</span>
                            <span class="${powerColor} text-xs">${changes.权势变动 > 0 ? '↑+' : '↓'}${changes.权势变动}</span>
                        </div>`;
                    }
                }
            }

            if(resultHtml) {
                resultGrid.innerHTML = resultHtml;
                resultDiv.classList.remove('hidden');
            }

            document.getElementById('event-finish-btn').classList.remove('hidden');
        }

        function continueEvent() {
            document.getElementById('event-finish-btn').classList.remove('hidden');
            document.getElementById('event-continue-btn').classList.add('hidden');
        }

        function finishEvent() {
            // 清理选中的妃嫔
            selectedConcubine = null;
            document.getElementById('step-event').classList.add('hidden');
            document.getElementById('main-game-screen').classList.remove('hidden');
            updateUI();
            autoSaveToSlot5(); // 自动存档到5号位
            if (gameState.action_points <= 0) {
                setTimeout(() => {
                    if (confirm("本月行动点已用尽，是否直接进入下个月？")) passMonth();
                }, 500);
            }
        }

        function showEventError(message) {
            document.getElementById('event-loading').classList.add('hidden');
            document.getElementById('event-description').innerHTML = `<p class="text-red-700 font-bold text-center">${message}</p>`;
            gameState.action_points++;
            document.getElementById('event-finish-btn').classList.remove('hidden');
        }

        function addMonthEvent(eventText) {
            const eventsDiv = document.getElementById('month-events');
            const eventItem = document.createElement('div');
            eventItem.className = 'border-b border-stone-200 pb-1';
            eventItem.textContent = `• ${eventText}`;
            eventsDiv.prepend(eventItem); // 新的在上面
            while (eventsDiv.children.length > 5) eventsDiv.removeChild(eventsDiv.lastChild);
        }

        async function passMonth() {
            const endingYear = gameState.current_year;
            const endingMonth = gameState.current_month;

            document.getElementById('main-game-screen').classList.add('hidden');
            document.getElementById('step-summary').classList.remove('hidden');
            document.getElementById('summary-year').textContent = endingYear;
            document.getElementById('summary-month').textContent = endingMonth;
            document.getElementById('summary-loading').classList.remove('hidden');
            document.getElementById('summary-content').classList.add('hidden');

            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += 5;
                if (progress > 90) clearInterval(progressInterval);
                document.getElementById('summary-progress').style.width = `${progress}%`;
            }, 200);

            showAILoading(); // 【注入】

            try {
                const requestData = {
                    皇帝个人信息: gameState.皇帝个人信息,
                    妃嫔信息: gameState.妃嫔信息,
                    玩家详细信息: gameState.玩家详细信息,
                    初始好感度信息: gameState.初始好感度信息,
                    事件簿: gameState.events_log,
                    当前年份: endingYear,
                    当前月份: endingMonth
                };

                const response = await fetch('/monthly_summary', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(requestData)
                });

                const data = await response.json();
                hideAILoading(); // 【注入】
                document.getElementById('summary-progress').style.width = '100%';
                clearInterval(progressInterval);

                if (data.success) {
                    setTimeout(() => { displayMonthlySummary(data.summary, endingYear, endingMonth); }, 500);
                } else {
                    showSummaryError("生成月终总结失败");
                }
            } catch (e) {
                hideAILoading();
                clearInterval(progressInterval);
                showSummaryError("连接失败");
            }
        }

        function displayMonthlySummary(summary, year, month) {
            document.getElementById('summary-loading').classList.add('hidden');
            document.getElementById('summary-content').classList.remove('hidden');

            // 1. 本月记事摘要
            const eventsDiv = document.getElementById('summary-events');
            eventsDiv.innerHTML = `<h3 class="font-bold text-[#8B0000] border-b border-[#d6cbb0] mb-2 pb-1">📜 本月要闻</h3>`;
            if (summary.本月记事摘要 && summary.本月记事摘要.length > 0) {
                summary.本月记事摘要.forEach((e, i) => eventsDiv.innerHTML += `<div class="text-sm py-1 border-b border-stone-100"><span class="text-[#8B0000] font-bold mr-2">${i+1}.</span>${e}</div>`);
            } else { eventsDiv.innerHTML += `<div class="text-stone-400 italic">无事发生</div>`; }

            // 2. 侍寝记录 (修复：增加了事件描述显示)
            const bedDiv = document.getElementById('summary-bedchamber');
            bedDiv.innerHTML = `<h3 class="font-bold text-pink-900 border-b border-pink-200 mb-2 pb-1">🛏️ 侍寝记录</h3>`;
            if (summary.侍寝记录 && summary.侍寝记录.length > 0) {
                summary.侍寝记录.forEach(r => {
                    bedDiv.innerHTML += `
                    <div class="text-sm py-2 border-b border-pink-50 last:border-0">
                        <div class="flex justify-between">
                            <span class="font-bold text-stone-800">${r.姓名}</span>
                            <span class="${r.圣宠变动>0?'text-pink-600':'text-stone-400'} text-xs">${r.圣宠变动>0?'+':''}圣宠${r.圣宠变动}</span>
                        </div>
                        <div class="text-xs text-stone-500 mt-1 pl-2 border-l-2 border-pink-200">${r.事件描述}</div>
                    </div>`;
                });
            } else { bedDiv.innerHTML += `<div class="text-stone-400 italic">本月无人侍寝</div>`; }

            // 3. 位份变动
            const rankDiv = document.getElementById('summary-ranks');
            rankDiv.innerHTML = `<h3 class="font-bold text-blue-900 border-b border-blue-200 mb-2 pb-1">📈 位份变动</h3>`;
            if (summary.位份变动 && summary.位份变动.length > 0) {
                summary.位份变动.forEach(c => {
                    const isUp = c.变动方向 === '+1';
                    rankDiv.innerHTML += `<div class="text-sm py-1 flex justify-between"><span>${c.姓名}</span> <span class="${isUp?'text-green-600':'text-red-600'} font-bold">${isUp?'晋升':'降级'} ${c.新位份||c.原位份}</span></div>`;
                });
            } else { rankDiv.innerHTML += `<div class="text-stone-400 italic">位份无变动</div>`; }

            // 4. 赏罚通知 (修复：原因显示 + 属性加成【字典格式】+ 手机端字体放大适配)
            const rewardDiv = document.getElementById('summary-rewards');
            rewardDiv.innerHTML = `<h3 class="font-bold text-yellow-900 border-b border-yellow-200 mb-2 pb-1 text-base md:text-sm">🎁 赏罚通知</h3>`;
            if (summary.赏罚通知 && summary.赏罚通知.length > 0) {
                summary.赏罚通知.forEach(n => {
                    const isReward = n.类型 === '赏赐';
                    rewardDiv.innerHTML += `
                    <div class="text-base md:text-sm py-2.5 border-b border-yellow-50/50 last:border-0">
                        <div class="flex justify-between items-center">
                            <span class="font-bold">${n.姓名}</span>
                            <span class="${isReward?'text-yellow-700 bg-yellow-100':'text-stone-600 bg-stone-200'} text-xs md:text-[10px] px-1.5 rounded">${n.类型}</span>
                        </div>
                        <div class="text-stone-700 mt-1.5">${n.内容}</div>
                        <div class="text-sm md:text-xs text-stone-400 mt-0.5 italic">原因：${n.原因}</div>
                        ${n.属性加成 && Object.keys(n.属性加成).length > 0 ? `<div class="text-sm md:text-xs mt-1.5">
                            <span class="text-stone-500">属性加成：</span>
                            ${Object.entries(n.属性加成).map(([attrName, num]) => {
                                const color = num > 0 ? 'text-emerald-600' : 'text-rose-600';
                                return `<span class="${color} font-medium">${attrName}${num > 0 ? '+' : ''}${num}</span>`;
                            }).join(' ｜ ')}
                        </div>` : ''}
                    </div>`;
                });
            } else { rewardDiv.innerHTML += `<div class="text-stone-400 italic text-sm">无赏罚记录</div>`; }

            // 消亡与结局 (保持不变)
            const elimDiv = document.getElementById('summary-elimination');
            elimDiv.innerHTML = '';
            if (summary.消亡名单 && summary.消亡名单.length > 0) {
                let html = `<div class="bg-gray-100 p-4 rounded shadow-sm border border-gray-300"><h3 class="font-bold text-gray-900 border-b border-gray-300 mb-2 pb-1">⚰️ 消亡名单</h3>`;
                summary.消亡名单.forEach(e => {
                     html += `<div class="text-sm py-1 flex justify-between"><span class="font-bold">${e.姓名}</span> <span class="text-red-900 bg-red-100 px-1 rounded">${e.消亡类型}</span></div><div class="text-xs text-gray-500 mb-1">原因：${e.原因}</div>`;
                });
                html += `</div>`;
                elimDiv.innerHTML = html;
            }

            if (summary.结局判定 && summary.结局判定.是否结局) {
                document.getElementById('summary-ending').classList.remove('hidden');
                document.getElementById('ending-content').innerHTML = `
                    <div class="text-4xl mb-4">🏁</div>
                    <h4 class="text-xl font-bold mb-2">命运已定</h4>
                    <p class="mb-4">${summary.结局判定.结局描述}</p>
                    <button onclick="location.reload()" class="bg-[#DAA520] text-[#2d1b1b] px-4 py-2 rounded font-bold">重新来过</button>
                `;
            }

            document.getElementById('summary-comment').textContent = summary.总结评语 || "岁月静好";

            // 调用逻辑应用函数
            applyMonthlySummary(summary, year, month);
        }

        function applyMonthlySummary(summary, year, month) {
            const timeKey = `${year}年${month}月`;

            // 1. 记录评语
            // if (summary.总结评语) {
            //     gameState.events_log.push({ time: timeKey, content: `【月结】${summary.总结评语}` });
            // }

            // 2. 逻辑处理：消亡
            if (summary.消亡名单) {
                summary.消亡名单.forEach(elim => {
                    gameState.events_log.push({ time: timeKey, content: `【消亡】${elim.姓名}被${elim.消亡类型}，原因：${elim.原因}` });

                    if (elim.姓名 === gameState.玩家详细信息.姓名) { gameState.gameOver = true; }
                    gameState.妃嫔信息 = gameState.妃嫔信息.filter(c => c.姓名 !== elim.姓名);
                    if(gameState.初始好感度信息[elim.姓名]) delete gameState.初始好感度信息[elim.姓名];
                });
            }

            // 3. 逻辑处理：侍寝 (修复：添加了事件记录)
            if (summary.侍寝记录) {
                summary.侍寝记录.forEach(r => {
                     // 记录事件簿
                     gameState.events_log.push({ time: timeKey, content: `【侍寝】${r.姓名}：${r.事件描述} (圣宠${r.圣宠变动>0?'+':''}${r.圣宠变动})` });

                     // 更新数值
                     if(r.姓名 === gameState.玩家详细信息.姓名) {
                         if(gameState.初始好感度信息["皇上"] === undefined) gameState.初始好感度信息["皇上"] = 0;
                         gameState.初始好感度信息["皇上"] += (r.圣宠变动||0);
                     } else {
                         const c = gameState.妃嫔信息.find(x => x.姓名 === r.姓名);
                         if(c) c.宠爱度 = (c.宠爱度||0) + (r.圣宠变动||0);
                     }
                });
            }

            // 4. 逻辑处理：位份变动
            if (summary.位份变动) {
                summary.位份变动.forEach(c => {
                    const isUp = c.变动方向 === '+1';
                    const action = isUp ? "晋升" : "降级";
                    gameState.events_log.push({ time: timeKey, content: `【${action}】${c.姓名}${action}为${c.新位份||c.原位份}，原因：${c.变动原因}` });

                    if(c.姓名 === gameState.玩家详细信息.姓名 && c.新位份) {
                         const rankMatch = c.新位份.match(/([正从][一二三四五六七]品)/);
                         if(rankMatch) {
                             gameState.玩家详细信息.品级 = rankMatch[1];
                             gameState.玩家详细信息.身份 = c.新位份.replace(rankMatch[1], '').trim();
                         }
                    } else {
                         const f = gameState.妃嫔信息.find(x => x.姓名 === c.姓名);
                         if(f) f.位分 = c.新位份;
                    }
                });
            }

            // 5. 逻辑处理：赏罚 (修复：添加了事件记录)
            if (summary.赏罚通知) {
                summary.赏罚通知.forEach(n => {
                    gameState.events_log.push({ time: timeKey, content: `【${n.类型}】${n.姓名}：${n.内容} (原因：${n.原因})` });

                    // 如果是玩家获得赏赐且有属性加成
                    if(n.姓名 === gameState.玩家详细信息.姓名 && n.属性加成) {
                        for(let key in n.属性加成) {
                            if(gameState.玩家详细信息.各项属性[key] !== undefined) {
                                gameState.玩家详细信息.各项属性[key] += n.属性加成[key];
                            }
                        }
                        gameState.初始好感度信息["皇上"] += (n.属性加成["圣宠"]||0);
                    } else{
                        const f = gameState.妃嫔信息.find(x => x.姓名 === n.姓名);
                        if(f) f.宠爱度 += (n.属性加成["圣宠"]||0);
                    }
                });
            }

            // 6. 每月固定恢复体力
            gameState.玩家详细信息.各项属性.体力 = Math.min(100, gameState.玩家详细信息.各项属性.体力 + 30);

            // 7. 更新人物介绍
            if (summary.人物介绍更新) {
                summary.人物介绍更新.forEach(update =>{
                    if(update.姓名 === gameState.玩家详细信息.姓名 && update.新介绍) {
                        gameState.玩家详细信息.介绍 = update.新介绍;
                    } else{
                        const f = gameState.妃嫔信息.find(x => x.姓名 === update.姓名);
                        if(f) f.介绍 = update.新介绍;
                    }
                });   
            }

            updateUI();
        }

        function showSummaryError(msg) {
            document.getElementById('summary-loading').classList.add('hidden');
            alert(msg);
            closeSummary();
        }

        function closeSummary() {
            // 更新所有人的资历
            updateSeniorityForAll();
            gameState.current_month++;
            if (gameState.current_month > 12) {
                gameState.current_month = 1;
                gameState.current_year++;
            }
            gameState.action_points = 5;
            // 重置养心殿求见次数
            gameState.heartroom_visits_this_month = 0;
            // 重置太医院调养状态
            hospitalData.nurturedThisMonth = false;
            document.getElementById('month-events').innerHTML = '';
            document.getElementById('step-summary').classList.add('hidden');
            document.getElementById('main-game-screen').classList.remove('hidden');
            checkTriennialSelection();
            updateUI();
            autoSaveToSlot5(); // 自动存档到5号位
        }

        function showEventLog() {
            openModal("事件簿");
            hideBackBtn();
            const body = document.getElementById('modal-body');
            if(gameState.events_log.length === 0) {
                body.innerHTML = "<p class='text-center opacity-50'>暂无前尘往事</p>";
                return;
            }
            let h = "<div class='space-y-3'>";
            [...gameState.events_log].reverse().forEach(l => {
                h += `<div class='border-l-4 border-[#d6cbb0] pl-3 py-1'><span class='text-xs font-bold text-[#8B0000]'>${l.time}</span><p class='text-stone-700'>${l.content}</p></div>`;
            });
            body.innerHTML = h + "</div>";
        }

        function showMainMenu() {
            if(!gameState.皇帝个人信息) return;
            openModal("人物志");
            hideBackBtn();
            document.getElementById('modal-body').innerHTML = `
                <div class="grid gap-3">
                    <button onclick="showEmperor()" class="p-4 bg-red-50 border border-red-100 rounded text-left font-bold flex justify-between shadow-sm">👑 皇帝档案 <span>▶</span></button>
                    <button onclick="showConcubines()" class="p-4 bg-orange-50 border border-orange-100 rounded text-left font-bold flex justify-between shadow-sm">🌸 后宫嫔妃 <span>▶</span></button>
                    <button onclick="showPlayer()" class="p-4 bg-blue-50 border border-blue-100 rounded text-left font-bold flex justify-between shadow-sm">👤 个人信息 <span>▶</span></button>
                </div>`;
        }
        
        // 恢复这三个关键函数
        function showEmperor() {
            setupBack(showMainMenu);
            const e = gameState.皇帝个人信息;
            document.getElementById('modal-body').innerHTML = `
                <h3 class='text-2xl font-ancient text-[#8B0000] border-b border-[#d6cbb0] mb-2'>${e.姓名}</h3>
                <p class='text-stone-500 mb-4 text-xs'>年龄：${e.年龄} | 性格：${e.性格} | 圣宠：${gameState.初始好感度信息["皇上"]||0}</p>
                <div class='bg-white p-3 border rounded shadow-inner text-justify leading-relaxed'>${e.介绍}</div>`;
        }
        
        function showConcubines() {
            setupBack(showMainMenu);
            const active = gameState.妃嫔信息.filter(c => !c.已消亡);
            let h = "<div class='space-y-2'>";
            if (active.length === 0) h += `<div class="text-center p-6 text-stone-500">后宫空虚</div>`;
            else {
                active.forEach((f, i) => {
                    h += `<button onclick="showConcubineDetail(${i})" class='w-full p-3 bg-white border border-stone-200 shadow-sm flex justify-between items-center rounded hover:bg-stone-50 text-left'>
                        <span><span class="font-bold text-[#8B0000]">${f.位分}</span> ${f.姓名}</span>
                        <span class='text-xs text-stone-400'>好感 ${gameState.初始好感度信息[f.姓名]||0}</span>
                    </button>`;
                });
            }
            document.getElementById('modal-body').innerHTML = h + "</div>";
        }
        
        function showConcubineDetail(idx) {
            setupBack(showConcubines);
            const f = gameState.妃嫔信息[idx];
            document.getElementById('modal-body').innerHTML = `
                <div class="mb-4 text-center">
                    <h3 class='text-xl font-bold text-[#8B0000]'>${f.姓名}</h3>
                    <p class='text-xs text-stone-500'>${f.位分} | ${f.家世}</p>
                </div>
                <div class="grid grid-cols-3 gap-3 mb-4 text-center">
                    <div class="bg-red-50 p-2 rounded"><div class="text-xs text-stone-400">权势</div><div class="font-bold">${f.权势}</div></div>
                    <div class="bg-pink-50 p-2 rounded"><div class="text-xs text-stone-400">宠爱</div><div class="font-bold">${f.宠爱度}</div></div>
                    <div class="bg-blue-50 p-2 rounded"><div class="text-xs text-stone-400">性格</div><div class="font-bold">${f.性格}</div></div>
                    <div class="bg-yellow-50 p-2 rounded"><div class="text-xs text-stone-400">好感</div><div class="font-bold">${gameState.初始好感度信息[f.姓名]||0}</div></div>
                    <div class="bg-green-50 p-2 rounded"><div class="text-xs text-stone-400">擅长</div><div class="font-bold">${f.擅长 || '无'}</div></div>
                    <div class="bg-purple-50 p-2 rounded"><div class="text-xs text-stone-400">资历</div><div class="font-bold">${f.资历 || '0年0月'}</div></div>
                </div>
                <div class='bg-white p-4 border rounded shadow-inner text-sm leading-relaxed'>${f.介绍}</div>`;
        }

        function showPlayer() {
            setupBack(showMainMenu);
            const p = gameState.玩家详细信息;
            let attrs = "<div class='grid grid-cols-2 gap-2 mt-4'>";
            for(let k in p.各项属性) attrs += `<div class='bg-stone-50 p-2 text-xs border border-stone-200 flex justify-between'><span>${k}</span><span class="font-bold">${p.各项属性[k]}</span></div>`;
            attrs += "</div>";

            // 处理家世显示，如果太长就截断
            let familyDisplay = p.家世 || "未记录";
            let fullFamily = familyDisplay;
            if (familyDisplay.length > 15) {
                familyDisplay = familyDisplay.substring(0, 12) + "...";
            }

            document.getElementById('modal-body').innerHTML = `
                <div class='bg-[#2d1b1b] text-[#f3e5ab] p-4 rounded mb-4 shadow text-center'>
                    <h3 class='text-2xl font-ancient'>${p.姓名}</h3>
                    <p class='text-xs opacity-75 mt-1'>${p.身份} | 品级：${p.品级||"无"}</p>
                    <p class='text-xs text-[#DAA520] mt-2 cursor-help' title="${fullFamily}">
                        家世：${familyDisplay}
                    </p>
                    <p class='text-xs text-[#DAA520] mt-1'>资历：${p.资历 || '0年0月'}</p>
                </div>
                <div class="bg-white p-3 rounded border text-sm mb-4">
                    <h4 class="font-bold text-[#8B0000] mb-1">人物介绍</h4>
                    <p>${p.介绍 || "暂无介绍"}</p>
                </div>
                ${attrs}`;
        }

        // === 选秀相关 ===
        async function generateOtherCandidates() {
            try {
                const response = await fetch('/generate_other_candidates', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        皇帝个人信息: gameState.皇帝个人信息,
                        妃嫔信息: gameState.妃嫔信息,
                        玩家详细信息: gameState.玩家详细信息
                    })
                });
                const data = await response.json();
                if (data.success) displayCandidatesResults(data.candidates);
            } catch (e) { enterMainGameDirectly(); }
        }

        function displayCandidatesResults(candidates) {
            const resultsContainer = document.getElementById('waiting-results');
            resultsContainer.classList.remove('hidden');
            resultsContainer.innerHTML = '';
            let passedCount = 0;
            let html = '<div class="space-y-3">';

            // 获取当前时间用于记录事件簿
            const timeKey = `${gameState.current_year}年${gameState.current_month}月`;

            candidates.forEach((c, i) => {
                const box = document.getElementById(`candidate-${i+1}`);
                box.classList.remove('animate-pulse');

                if (c.殿选结果 === '通过') {
                    // 更新上方四个小方块的状态
                    box.classList.add('border-green-500', 'bg-green-50');
                    box.innerHTML = `<div class="font-bold text-green-800">${c.姓名}</div><div class="text-xs text-green-600">${c.位分}</div>`;
                    passedCount++;

                    // 1. 数据入库
                    gameState.妃嫔信息.push({
                        姓名: c.姓名, 
                        位分: c.位分, 
                        家世: c.家世, 
                        权势: c.权势, 
                        宠爱度: c.宠爱度, 
                        性格: c.性格, 
                        擅长: c.擅长 || '无',  // 新增：确保有擅长字段
                        资历: "0年0月",  // 新增：新秀女资历初始为0
                        介绍: c.介绍
                    });
                    if(!gameState.初始好感度信息) gameState.初始好感度信息={};
                    gameState.初始好感度信息[c.姓名]=0;

                    // 2. 【新增】记入事件簿
                    gameState.events_log.push({
                        time: timeKey,
                        content: `【殿选】${c.姓名}(${c.性格})入选，封为${c.位分}。皇上评价：“${c.皇上评价}”`
                    });

                    // 3. 【新增】UI显示完善：增加了性格和皇上评价
                    html += `
                    <div class="p-3 bg-green-50 border border-green-200 rounded text-sm relative overflow-hidden">
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-bold text-green-800 text-lg">${c.姓名}</span>
                            <span class="font-bold text-white bg-green-700 px-2 py-0.5 rounded text-xs">${c.位分}</span>
                        </div>
                        <div class="text-xs text-stone-600 mb-2">
                            <span class="bg-white px-1 rounded border border-stone-200 mr-2">性格：${c.性格}</span>
                            <span>家世：${c.家世}</span>
                        </div>
                        <div class="text-xs text-stone-500 italic bg-white/60 p-2 rounded border-l-2 border-stone-400">
                            "皇上评价：${c.皇上评价}"
                        </div>
                    </div>`;
                } else {
                    // 落选的处理
                    box.innerHTML = `<div class="text-stone-400">${c.姓名}</div><div class="text-xs text-stone-300">落选</div>`;
                    html += `
                    <div class="p-2 bg-stone-100 border border-stone-200 rounded text-sm flex justify-between opacity-75">
                        <span class="text-stone-500">${c.姓名}</span>
                        <span class="text-stone-400 text-xs">落选：${c.皇上评价}</span>
                    </div>`;
                }
            });
            html += '</div>';

            // 显示统计结果
            html += `<div class="text-center text-xs text-[#8B0000] mt-4 font-bold">本次共入选 ${passedCount} 人</div>`;

            resultsContainer.innerHTML = html;
            document.getElementById('waiting-footer').classList.remove('hidden');
        }

        function enterMainGameDirectly() {
            document.getElementById('step-waiting').classList.add('hidden');
            document.getElementById('main-game-screen').classList.remove('hidden');
            document.getElementById('title').innerText = "后宫浮生";
            updateUI();
            autoSaveToSlot5(); // 自动存档到5号位
        }

        // === 存档系统 ===
        const SAVE_PREFIX = 'palace_sim_save_'; 
        const SAVE_SLOTS = 5;

        // ======== 新增：自动存档到5号档位 核心函数 (固定存5号位，不影响其他档位) ========
        function autoSaveToSlot5() {
            // 只在主界面/关键游戏节点执行自动存档，避免无效存档
            if(document.getElementById('main-game-screen').classList.contains('hidden') && 
               document.getElementById('step-summary').classList.contains('hidden') &&
               document.getElementById('step-event').classList.contains('hidden')) {
                return;
            }
            // 固定写入5号存档位
            const slot = 5;
            const data = {
                version: '1.0',
                saveTime: new Date().toLocaleString(),
                gameState: gameState
            };
            localStorage.setItem(SAVE_PREFIX + slot, JSON.stringify(data));
            // 显示存档成功提示，3秒后自动消失
            const tip = document.getElementById('autoSaveTip');
            tip.classList.add('show');
            setTimeout(() => { tip.classList.remove('show'); }, 3000);
        }
        // ======== 自动存档函数结束 ========

        function showLoadModal() { openSaveModal(); loadSaveList(); }
        function openSaveModal() { document.getElementById('save-modal').classList.remove('hidden'); }
        function closeSaveModal() { document.getElementById('save-modal').classList.add('hidden'); }

        function loadSaveList() {
            const div = document.getElementById('save-slots');
            div.innerHTML = '';
            let count = 0;
            for(let i=1; i<=SAVE_SLOTS; i++) {
                const data = localStorage.getItem(SAVE_PREFIX + i);
                let content = '';
                if(data) {
                    count++;
                    const p = JSON.parse(data);
                    content = `
                        <div class="flex justify-between items-center">
                            <div><span class="font-bold text-[#8B0000]">存档 ${i}</span> <span class="text-xs text-stone-500">${p.saveTime}</span></div>
                            <div class="space-x-2">
                                <button onclick="loadGame(${i})" class="bg-[#5c3a3a] text-white text-xs px-2 py-1 rounded">读取</button>
                                <button onclick="deleteSave(${i})" class="bg-red-800 text-white text-xs px-2 py-1 rounded">删除</button>
                            </div>
                        </div>
                        <div class="text-xs text-stone-600 mt-1">${p.gameState.玩家详细信息.姓名} | 第${p.gameState.current_year}年</div>
                    `;
                } else {
                    content = `
                        <div class="flex justify-between items-center text-stone-400">
                            <span>存档 ${i} (空)</span>
                            <button onclick="saveToSlot(${i})" class="bg-[#8B4513] text-white text-xs px-2 py-1 rounded">保存</button>
                        </div>
                    `;
                }
                div.innerHTML += `<div class="save-slot p-3 rounded">${content}</div>`;
            }
            document.getElementById('save-count').innerText = count;
        }

        function saveGame() {
            if(document.getElementById('main-game-screen').classList.contains('hidden')) { alert("仅在主界面可存档"); return; }
            showLoadModal(); // 复用界面
        }

        function saveToSlot(slot) {
            const data = {
                version: '1.0',
                saveTime: new Date().toLocaleString(),
                gameState: gameState
            };
            localStorage.setItem(SAVE_PREFIX + slot, JSON.stringify(data));
            loadSaveList();
            alert(`存档 ${slot} 保存成功`);
        }

        function loadGame(slot) {
            const data = localStorage.getItem(SAVE_PREFIX + slot);
            if(!data) return;
            if(!confirm("确定读取进度？当前未保存的进度将丢失。")) return;
            
            const p = JSON.parse(data);
            gameState = p.gameState;

            // ======== 新增：初始化可能缺失的字段（为了兼容旧存档）========
            // 初始化太医列表（如果存档中没有这个字段）
            if (!gameState.太医列表) {
                gameState.太医列表 = [];
            }

            // 初始化养心殿求见次数（如果存档中没有这个字段）
            if (gameState.heartroom_visits_this_month === undefined) {
                gameState.heartroom_visits_this_month = 0;
            }

            // 初始化新秀女数组（如果存档中没有这个字段）
            if (!gameState.new_draft_candidates) {
                gameState.new_draft_candidates = [];
            }

            // 初始化玩家资历（如果存档中没有这个字段）
            if (!gameState.玩家详细信息.资历) {
                gameState.玩家详细信息.资历 = "0年0月";
            }

            // 初始化所有妃嫔的资历
            if (gameState.妃嫔信息 && gameState.妃嫔信息.length > 0) {
                gameState.妃嫔信息.forEach(concubine => {
                    if (!concubine.资历) {
                        concubine.资历 = "0年0月";
                    }
                });
            }
            // ======== 兼容性修复结束 ========
            
            // 恢复界面
            ALL_SCREENS.forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById('main-game-screen').classList.remove('hidden');
            document.getElementById('title').innerText = "后宫浮生";
            closeSaveModal();
            updateUI();
            
            // 恢复本月记事
            const eventsDiv = document.getElementById('month-events');
            eventsDiv.innerHTML = '';
            const monthKey = `${gameState.current_year}年${gameState.current_month}月`;
            gameState.events_log.filter(e => e.time === monthKey).slice(-5).forEach(e => {
                const d = document.createElement('div');
                d.className = 'border-b border-stone-200 pb-1';
                d.textContent = `• ${e.content}`;
                eventsDiv.appendChild(d);
            });
            autoSaveToSlot5(); // 加载存档后，自动同步到5号位
        }
        
        function deleteSave(slot) {
            if(confirm("确定删除？")) {
                localStorage.removeItem(SAVE_PREFIX + slot);
                loadSaveList();
            }
        }

        // === 自动选秀 ===
        function checkTriennialSelection() {
            if (gameState.current_year > 1 && (gameState.current_year - 1) % 3 === 0 && gameState.current_month === 1) {
                triggerAutomaticDraft();
            } else {
                document.getElementById('draft-notification').classList.add('hidden');
                gameState.new_draft_candidates = [];
            }
        }

        async function triggerAutomaticDraft() {
            if (gameState.new_draft_candidates.length > 0 && gameState.current_month !== 1) return;
            try {
                const response = await fetch('/generate_other_candidates', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        皇帝个人信息: gameState.皇帝个人信息,
                        妃嫔信息: gameState.妃嫔信息,
                        玩家详细信息: gameState.玩家详细信息
                    })
                });
                const data = await response.json();
                if(data.success) {
                    const passed = data.candidates.filter(c => c.殿选结果 === '通过');
                    if(passed.length > 0) {
                        gameState.new_draft_candidates = passed;
                        passed.forEach(c => {
                            gameState.妃嫔信息.push({
                                姓名: c.姓名, 
                                位分: c.位分, 
                                家世: c.家世, 
                                权势: c.权势, 
                                宠爱度: c.宠爱度, 
                                性格: c.性格, 
                                擅长: c.擅长 || '无',  // 新增：确保有擅长字段
                                资历: "0年0月",  // 新增：新秀女资历初始为0
                                介绍: c.介绍
                            });
                            gameState.初始好感度信息[c.姓名] = 0;
                            gameState.events_log.push({time: `${gameState.current_year}年${gameState.current_month}月`, content: `【大选】${c.姓名}入宫，封为${c.位分}`});
                        });
                        document.getElementById('draft-notification').classList.remove('hidden');
                        updateUI();
                    }
                }
            } catch(e) {}
        }
        
        function showDraftResults() {
            openModal("新晋宫嫔");
            hideBackBtn();
            const list = gameState.new_draft_candidates;
            let html = "<div class='space-y-2'>";
            list.forEach(c => {
                html += `<div class="p-2 border border-green-200 bg-green-50 rounded"><span class="font-bold text-green-800">${c.姓名}</span> <span class="text-xs bg-white border px-1 rounded">${c.位分}</span><div class="text-xs text-stone-500 mt-1">${c.皇上评价}</div></div>`;
            });
            document.getElementById('modal-body').innerHTML = html + "</div>";
        }

        function resetGame() {
            if(confirm("确定重置游戏？")) location.reload();
        }

        // 辅助：模态框
        function openModal(t) { document.getElementById('info-overlay').classList.remove('hidden'); document.getElementById('modal-title').innerText = t; }
        function closeModal() { document.getElementById('info-overlay').classList.add('hidden'); }
        function closeEventModal() { document.getElementById('event-modal').classList.add('hidden'); }
        function setupBack(f) { const b = document.getElementById('back-btn'); b.classList.remove('hidden'); b.onclick = f; }
        function hideBackBtn() { document.getElementById('back-btn').classList.add('hidden'); }

        // 初始化
        window.addEventListener('load', function() {
            switchScreen('step-identity');
            // 检查存档
            let hasSave = false;
            for(let i=1; i<=SAVE_SLOTS; i++) { if(localStorage.getItem(SAVE_PREFIX+i)) hasSave=true; }
            if(hasSave) {
                const container = document.querySelector('#step-identity .grid');
                if(container) {
                     const btn = document.createElement('button');
                     btn.className = 'btn-palace py-4 text-xl bg-[#2d3748] border-gray-600 mt-2';
                     btn.innerText = '📂 继续旧档';
                     btn.onclick = showLoadModal;
                     container.appendChild(btn);
                }
            }
        });
        // ======== 修复版：游戏须知弹窗 核心控制逻辑【无报错、100%生效】 ========
        function showTab(tabId) {
            // 隐藏所有标签+取消按钮选中状态
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
                tab.classList.remove('block');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.style.color = '#8b7355';
                btn.style.borderBottom = 'none';
            });
            // 显示选中标签+高亮选中按钮
            document.getElementById(tabId).classList.remove('hidden');
            document.getElementById(tabId).classList.add('block');
            document.querySelectorAll('.tab-btn').forEach(btn => {
                if(btn.innerText === (tabId == 'guide' ? '新手必看' : '更新日记')){
                    btn.classList.add('active');
                    btn.style.color = '#8B4513';
                    btn.style.borderBottom = '2px solid #8B4513';
                }
            });
        }
        // 打开弹窗
        function openGameGuide() {
            document.getElementById('gameGuideModal').style.display = 'flex';
            document.getElementById('gameGuideBtn').style.display = 'none';
        }
        // 关闭弹窗
        function closeGameGuide() {
            document.getElementById('gameGuideModal').style.display = 'none';
            document.getElementById('gameGuideBtn').style.display = 'block';
        }
        // ======== 弹窗JS逻辑结束 ========

        // 页面加载完成后，强制打开弹窗，100%必弹！
        window.onload = function(){ openGameGuide(); }

        // === 六宫相关函数 ===

        // 全局变量存储选中的妃嫔信息
        let selectedConcubine = null;

        // 访问六宫 - 第一步：选择妃嫔
        function visitSixPalaces() {
            if (gameState.action_points <= 0) {
                alert("本月行动点已用尽，请结束本月");
                return;
            }

            // 隐藏主界面，显示妃嫔选择界面
            switchScreen('step-six-palaces-select');

            // 清空并生成妃嫔列表
            const concubineList = document.getElementById('concubine-list');
            concubineList.innerHTML = '';

            // 获取现有妃嫔（排除玩家自己）
            const activeConcubines = gameState.妃嫔信息.filter(c => 
                !c.已消亡 && c.姓名 !== gameState.玩家详细信息.姓名
            );

            if (activeConcubines.length === 0) {
                concubineList.innerHTML = '<div class="text-center text-stone-500 w-full py-8">暂无其他妃嫔</div>';
                return;
            }

            // 为每个妃嫔创建卡片
            activeConcubines.forEach(concubine => {
                const favor = gameState.初始好感度信息[concubine.姓名] || 0;
                const favorClass = favor > 20 ? 'text-green-600' : favor < -10 ? 'text-red-600' : 'text-stone-600';

                const card = document.createElement('div');
                card.className = 'flex-shrink-0 w-32 bg-white border border-[#d6cbb0] rounded-lg p-3 shadow-sm cursor-pointer hover:shadow-md transition-all';
                card.onclick = () => selectConcubine(concubine);

                card.innerHTML = `
                    <div class="text-center">
                        <div class="text-lg mb-1">🌸</div>
                        <div class="font-bold text-[#8B0000] text-sm truncate">${concubine.姓名}</div>
                        <div class="text-xs text-stone-500 truncate">${concubine.位分}</div>
                        <div class="text-xs mt-2 ${favorClass} font-bold">
                            好感: ${favor > 0 ? '+' : ''}${favor}
                        </div>
                    </div>
                `;

                concubineList.appendChild(card);
            });
        }

        // 选择妃嫔
        function selectConcubine(concubine) {
            selectedConcubine = concubine;

            // 更新互动选择界面的信息
            document.getElementById('interaction-target-name').textContent = concubine.姓名;
            document.getElementById('target-rank').textContent = concubine.位分;
            document.getElementById('target-personality').textContent = concubine.性格;
            document.getElementById('target-power').textContent = concubine.权势;
            document.getElementById('target-favor').textContent = gameState.初始好感度信息[concubine.姓名] || 0;

            // 显示互动选择界面
            switchScreen('step-six-interaction');
        }

        // 返回妃嫔选择界面
        function backToConcubineSelect() {
            switchScreen('step-six-palaces-select');
        }

        // 返回主界面
        function backToMainGame() {
            switchScreen('main-game-screen');
        }

        // 随机拜访（使用原逻辑）
        function selectRandomVisit() {
            // 扣减行动点
            gameState.action_points--;

            // 直接调用原生的visitLocation函数，但传入"六宫"作为地点
            // 这将使用原有的事件生成逻辑
            window.currentEventData = null;
            selectedConcubine = null;

            // 切换到事件界面
            switchScreen('step-event');

            // 设置界面信息
            document.getElementById('event-player-name').textContent = gameState.玩家详细信息.姓名;
            document.getElementById('event-player-rank').textContent = gameState.玩家详细信息.身份;
            document.getElementById('event-location-name').textContent = '六宫';
            document.getElementById('event-year').textContent = gameState.current_year;
            document.getElementById('event-month').textContent = gameState.current_month;
            document.getElementById('event-main-title').textContent = '六宫记事';
            document.getElementById('event-sub-title').textContent = "正在生成事件...";

            // 清空内容
            document.getElementById('event-description').innerHTML = '';
            document.getElementById('event-preview').classList.add('hidden');
            document.getElementById('event-choices').classList.add('hidden');
            document.getElementById('event-result').classList.add('hidden');
            document.getElementById('event-continue-btn').classList.add('hidden');
            document.getElementById('event-finish-btn').classList.add('hidden');
            document.getElementById('event-loading').classList.remove('hidden');

            // 调用后端接口
            showAILoading();

            const requestData = {
                皇帝个人信息: gameState.皇帝个人信息,
                妃嫔信息: gameState.妃嫔信息,
                玩家详细信息: gameState.玩家详细信息,
                初始好感度信息: gameState.初始好感度信息,
                事件簿: gameState.events_log.slice(-10),
                当前地点: '六宫',
                当前时间: `${gameState.current_year}年${gameState.current_month}月`,
                剩余行动点: gameState.action_points
            };

            fetch('/generate_location_event', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                hideAILoading();
                if (data.success) {
                    window.currentEventData = data.event;
                    window.currentEventLocation = '六宫';
                    displayEventContent(data.event);
                } else {
                    showEventError("事件生成失败，请重试");
                }
            })
            .catch(e => {
                hideAILoading();
                showEventError("连接失败，请检查网络连接");
            });
        }

        // 选择互动方式
        async function selectInteraction(interactionType) {
            if (!selectedConcubine) {
                alert("请先选择妃嫔");
                return;
            }

            // 扣减行动点
            gameState.action_points--;

            // 切换到事件界面
            switchScreen('step-event');

            // 设置界面信息
            document.getElementById('event-player-name').textContent = gameState.玩家详细信息.姓名;
            document.getElementById('event-player-rank').textContent = gameState.玩家详细信息.身份;
            document.getElementById('event-location-name').textContent = '六宫';
            document.getElementById('event-year').textContent = gameState.current_year;
            document.getElementById('event-month').textContent = gameState.current_month;
            document.getElementById('event-main-title').textContent = '六宫记事';

            // 根据互动类型设置副标题
            const interactionTitles = {
                'friendly': '友好问安',
                'casual': '随意闲聊',
                'sarcastic': '冷嘲热讽',
                'consulted': '请教技艺',
                'ask_for_favor': '请求美言'
            };
            document.getElementById('event-sub-title').textContent = `对${selectedConcubine.姓名}${interactionTitles[interactionType]}`;

            // 清空内容
            document.getElementById('event-description').innerHTML = '';
            document.getElementById('event-preview').classList.add('hidden');
            document.getElementById('event-choices').classList.add('hidden');
            document.getElementById('event-result').classList.add('hidden');
            document.getElementById('event-continue-btn').classList.add('hidden');
            document.getElementById('event-finish-btn').classList.add('hidden');
            document.getElementById('event-loading').classList.remove('hidden');

            // 调用新的后端接口
            showAILoading();

            try {
                const requestData = {
                    皇帝个人信息: gameState.皇帝个人信息,
                    妃嫔信息: gameState.妃嫔信息,
                    玩家详细信息: gameState.玩家详细信息,
                    初始好感度信息: gameState.初始好感度信息,
                    事件簿: gameState.events_log.slice(-10),
                    当前地点: '六宫',
                    当前时间: `${gameState.current_year}年${gameState.current_month}月`,
                    剩余行动点: gameState.action_points,
                    目标妃嫔: selectedConcubine.姓名,
                    互动类型: interactionType
                };

                const response = await fetch('/generate_six_palaces_event', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(requestData)
                });

                const data = await response.json();
                hideAILoading();

                if (data.success) {
                    // 直接显示事件结果（不需要选项）
                    document.getElementById('event-loading').classList.add('hidden');

                    const descriptionDiv = document.getElementById('event-description');
                    descriptionDiv.innerHTML = `<div class="space-y-3"><p class="leading-relaxed animate-fade-in">${data.event.事件描述}</p></div>`;

                    // 应用事件结果
                    const resultData = {
                        详细事件描述: data.event.事件描述,
                        玩家属性变动: data.event.玩家属性变动 || {},
                        人物好感度变动: data.event.人物好感度变动 || {},
                        妃嫔属性变动: data.event.妃嫔属性变动 || [],
                        // 后宫风向: data.event.后宫风向 || "",
                        事件概括: data.event.事件概括 || ""
                    };

                    // 保存当前事件数据
                    window.currentEventData = {
                        初始事件描述: data.event.事件描述,
                        选项: [resultData]
                    };
                    window.currentEventLocation = '六宫';

                    // 应用结果
                    applyEventResult(resultData, false);
                } else {
                    showEventError("事件生成失败，请重试");
                }
            } catch (e) {
                hideAILoading();
                showEventError("连接失败，请检查网络连接");
            }
        }

        // 资历增加一个月
        function addOneMonthToSeniority(seniorityStr) {
            if (!seniorityStr) return "0年0月";

            // 解析字符串，格式为"X年Y月"
            const match = seniorityStr.match(/(\d+)年(\d+)月/);
            if (!match) return seniorityStr;

            let years = parseInt(match[1]);
            let months = parseInt(match[2]);

            months += 1;
            if (months >= 12) {
                years += 1;
                months = months - 12;
            }

            return `${years}年${months}月`;
        }

        // 每月结束时更新所有人的资历
        function updateSeniorityForAll() {
            // 更新玩家资历
            if (!gameState.玩家详细信息.资历) {
                gameState.玩家详细信息.资历 = "0年0月";
            }
            gameState.玩家详细信息.资历 = addOneMonthToSeniority(gameState.玩家详细信息.资历);

            // 更新所有妃嫔资历
            gameState.妃嫔信息.forEach(concubine => {
                if (!concubine.资历) {
                    concubine.资历 = "0年0月";
                }
                concubine.资历 = addOneMonthToSeniority(concubine.资历);
            });
        }

        // === 养心殿相关函数 ===

        // 判断养心殿情况分类
        function getHeartRoomSituation() {
            const emperorFavor = gameState.初始好感度信息["皇上"] || 0;
            const playerRank = gameState.玩家详细信息.品级 + gameState.玩家详细信息.身份;

            // 解析位分等级
            let rankLevel = 14; // 默认最低
            for (const [rankName, level] of Object.entries(RANK_LEVELS)) {
                if (playerRank.includes(rankName)) {
                    rankLevel = level;
                    break;
                }
            }

            // 判断情况
            if (emperorFavor < 40) {
                if (rankLevel >= 10) return '低好感低位分';
                else if (rankLevel >= 4) return '低好感中位分';
                else return '低好感高位分';
            } else if (emperorFavor < 80) {
                if (rankLevel >= 10) return '中好感低位分';
                else if (rankLevel >= 4) return '中好感中位分';
                else return '中好感高位分';
            } else {
                if (rankLevel >= 10) return '高好感低位分';
                else if (rankLevel >= 4) return '高好感中位分';
                else return '高好感高位分';
            }
        }

        // 全局变量存储养心殿流程数据
        let heartRoomData = {
            situation: '',      // 情况分类（低低、低中、低高...）
            eventTemplate: '',  // 使用的模板
            requestEvent: {},   // 求见事件数据
            requestChoice: '',  // 玩家选择的求见选项
            requestResult: {},  // 求见结果
            accessGranted: false // 是否获得进入许可
        };

        // 访问养心殿
        function visitHeartRoom() {
            // 检查本月求见次数
            if (gameState.heartroom_visits_this_month >= 2) {
                alert("本月求见次数已达上限（2次），请下月再来");
                return;
            }
            if (gameState.action_points <= 0) {
                alert("本月行动点已用尽，请结束本月");
                return;
            }

            // 扣减行动点
            gameState.action_points--;

            // 增加求见次数
            gameState.heartroom_visits_this_month++;

            // 获取情况分类
            const situation = getHeartRoomSituation();

            // 隐藏主界面，显示养心殿求见界面
            switchScreen('step-heartroom-request');

            // 更新界面信息
            document.getElementById('heartroom-player-rank').textContent = gameState.玩家详细信息.品级+gameState.玩家详细信息.身份;

            // 显示加载状态
            document.getElementById('heartroom-event-description').innerHTML = '';
            document.getElementById('heartroom-choices').classList.add('hidden');
            document.getElementById('heartroom-result').classList.add('hidden');
            document.getElementById('heartroom-loading').classList.remove('hidden');
            document.getElementById('enter-heartroom-btn').classList.add('hidden');
            document.getElementById('heartroom-back-btn').classList.add('hidden');

            // 调用后端生成养心殿求见事件
            generateHeartRoomEvent(situation);
        }

        // 生成养心殿求见事件
        async function generateHeartRoomEvent(situation) {
            showAILoading();

            try {
                const requestData = {
                    皇帝个人信息: gameState.皇帝个人信息,
                    妃嫔信息: gameState.妃嫔信息,
                    玩家详细信息: gameState.玩家详细信息,
                    初始好感度信息: gameState.初始好感度信息,
                    事件簿: gameState.events_log.slice(-10),
                    当前时间: `${gameState.current_year}年${gameState.current_month}月`,
                    情况分类: situation
                };

                const response = await fetch('/generate_heartroom_event', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(requestData)
                });

                const data = await response.json();
                hideAILoading();

                if (data.success) {
                    heartRoomData = {
                        situation: situation,
                        requestEvent: data.event,
                        accessGranted: data.event.是否获得进入许可 || false
                    };
                    displayHeartRoomEvent(data.event);
                } else {
                    showHeartRoomError("生成养心殿事件失败");
                }
            } catch (e) {
                hideAILoading();
                showHeartRoomError("连接失败");
            }
        }

        // 显示养心殿求见事件
        function displayHeartRoomEvent(eventData) {
            document.getElementById('heartroom-loading').classList.add('hidden');

            // 显示事件描述
            document.getElementById('heartroom-event-description').innerHTML = 
                `<p class="leading-relaxed">${eventData.事件描述}</p>`;

            // 显示选项
            const choiceButtonsDiv = document.getElementById('heartroom-choice-buttons');
            choiceButtonsDiv.innerHTML = '';

            eventData.选项.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'w-full btn-palace py-3 text-sm text-left px-4';
                button.textContent = `${index+1}. ${option.选项描述}`;
                button.onclick = () => selectHeartRoomOption(index);
                choiceButtonsDiv.appendChild(button);
            });

            document.getElementById('heartroom-choices').classList.remove('hidden');
        }

        // 选择求见选项
        function selectHeartRoomOption(choiceIndex) {
            const selectedOption = heartRoomData.requestEvent.选项[choiceIndex];

            // 显示结果
            displayHeartRoomResult(selectedOption, choiceIndex);
        }

        // 显示求见结果
        function displayHeartRoomResult(optionResult, choiceIndex) {
            // 应用属性变动
            applyHeartRoomResult(optionResult);

            // 显示结果描述
            document.getElementById('heartroom-result-description').innerHTML = 
                `<p class="mb-3">${optionResult.结果描述}</p>`;

            // 显示属性变动
            const resultChangesDiv = document.getElementById('heartroom-result-changes');
            let changesHtml = '';

            // 玩家属性变动
            if (optionResult.玩家属性变动) {
                for (const attr in optionResult.玩家属性变动) {
                    const change = optionResult.玩家属性变动[attr];
                    if (change !== 0) {
                        const color = change > 0 ? 'text-green-600' : 'text-red-600';
                        changesHtml += `<div class="flex justify-between p-1">
                            <span class="text-xs">${attr}</span>
                            <span class="${color} text-xs">${change > 0 ? '+' : ''}${change}</span>
                        </div>`;
                    }
                }
            }

            // 好感度变动
            if (optionResult.人物好感度变动) {
                for (const person in optionResult.人物好感度变动) {
                    const change = optionResult.人物好感度变动[person];
                    if (change !== 0) {
                        const color = change > 0 ? 'text-pink-600' : 'text-blue-600';
                        changesHtml += `<div class="flex justify-between p-1">
                            <span class="text-xs">${person}好感</span>
                            <span class="${color} text-xs">${change > 0 ? '+' : ''}${change}</span>
                        </div>`;
                    }
                }
            }

            // 妃嫔属性变动
            if (optionResult.妃嫔属性变动 && Array.isArray(optionResult.妃嫔属性变动)) {
                optionResult.妃嫔属性变动.forEach(change => {
                    if (change.圣宠变动 !== 0 || change.权势变动 !== 0) {
                        const favorColor = change.圣宠变动 > 0 ? 'text-yellow-600' : 'text-gray-600';
                        const powerColor = change.权势变动 > 0 ? 'text-purple-600' : 'text-gray-600';

                        if (change.圣宠变动 !== 0) {
                            changesHtml += `<div class="flex justify-between p-1">
                                <span class="text-xs">${change.姓名}·圣宠</span>
                                <span class="${favorColor} text-xs">${change.圣宠变动 > 0 ? '↑+' : '↓'}${change.圣宠变动}</span>
                            </div>`;
                        }

                        if (change.权势变动 !== 0) {
                            changesHtml += `<div class="flex justify-between p-1">
                                <span class="text-xs">${change.姓名}·权势</span>
                                <span class="${powerColor} text-xs">${change.权势变动 > 0 ? '↑+' : '↓'}${change.权势变动}</span>
                            </div>`;
                        }
                    }
                });
            }

            resultChangesDiv.innerHTML = changesHtml;

            // 隐藏选项，显示结果
            document.getElementById('heartroom-choices').classList.add('hidden');
            document.getElementById('heartroom-result').classList.remove('hidden');

            // 记录事件概括
            if (optionResult.事件概括) {
                const timeKey = `${gameState.current_year}年${gameState.current_month}月`;
                gameState.events_log.push({
                    time: timeKey,
                    content: `【养心殿求见】${optionResult.事件概括}`
                });
            }

            // 根据是否获得许可显示不同按钮
            if (optionResult.获得进入许可) {
                heartRoomData.accessGranted = true;
                heartRoomData.selectedOption = optionResult;
                document.getElementById('enter-heartroom-btn').classList.remove('hidden');
            } else {
                heartRoomData.accessGranted = false;
                
                // 添加到本月起居注
                addMonthEvent(`养心殿求见失败：${optionResult.事件概括}`);
                document.getElementById('heartroom-back-btn').classList.remove('hidden');
            }
        }

        // 应用养心殿求见结果
        function applyHeartRoomResult(optionResult) {
            // 玩家属性变动
            if (optionResult.玩家属性变动) {
                for (const attr in optionResult.玩家属性变动) {
                    if (gameState.玩家详细信息.各项属性[attr] !== undefined) {
                        gameState.玩家详细信息.各项属性[attr] += optionResult.玩家属性变动[attr];
                        gameState.玩家详细信息.各项属性[attr] = Math.max(0, Math.min(100, gameState.玩家详细信息.各项属性[attr]));
                    }
                }
            }

            // 好感度变动
            if (optionResult.人物好感度变动) {
                for (const person in optionResult.人物好感度变动) {
                    const key = (person === "皇上" || person === gameState.皇帝个人信息.姓名) ? "皇上" : person;
                    if (gameState.初始好感度信息[key] === undefined) gameState.初始好感度信息[key] = 0;
                    gameState.初始好感度信息[key] += optionResult.人物好感度变动[person];
                }
            }

            // 妃嫔属性变动
            if (optionResult.妃嫔属性变动 && Array.isArray(optionResult.妃嫔属性变动)) {
                optionResult.妃嫔属性变动.forEach(change => {
                    const concubine = gameState.妃嫔信息.find(c => c.姓名 === change.姓名);
                    if (concubine) {
                        if (concubine.宠爱度 === undefined) concubine.宠爱度 = 0;
                        if (concubine.权势 === undefined) concubine.权势 = 0;

                        concubine.宠爱度 += change.圣宠变动 || 0;
                        concubine.宠爱度 = Math.max(0, Math.min(100, concubine.宠爱度));

                        concubine.权势 += change.权势变动 || 0;
                        concubine.权势 = Math.max(0, Math.min(100, concubine.权势));
                    }
                });
            }
        }

        // 进入养心殿内部
        function enterHeartroom() {
            // 切换到养心殿内部界面
            switchScreen('step-heartroom-inside');

            // 显示当前情景
            const contextDiv = document.getElementById('heartroom-inside-context');
            contextDiv.innerHTML = `
                <p><strong>求见过程：</strong>${heartRoomData.requestEvent.事件描述}</p>
                <p><strong>你的选择：</strong>${heartRoomData.selectedOption.选项描述}</p>
                <p><strong>求见结果：</strong>${heartRoomData.selectedOption.结果描述}</p>
            `;

            // 显示固定选项
            const optionsDiv = document.getElementById('heartroom-inside-options');
            optionsDiv.innerHTML = '';

            // 固定内部选项
            const fixedOptions = [
                { name: "恭敬请安", desc: "按规矩行大礼请安", icon: "🙇‍♀️" },
                { name: "亲手奉茶", desc: "亲自为皇上斟茶奉茶", icon: "🍵" },
                { name: "主动磨墨", desc: "为正在批阅奏折的皇上磨墨", icon: "🖋️" },
                { name: "倾诉心事", desc: "向皇上倾诉心事与烦恼", icon: "💬" },
                { name: "撒娇逗趣", desc: "以轻松活泼的方式与皇上说笑", icon: "😊" },
                { name: "展示才艺", desc: "为皇上展示自己的才艺", icon: "🎨" },
                { name: "关心政务", desc: "适度关心国家大事", icon: "🏛️" }
            ];

            fixedOptions.forEach(option => {
                const button = document.createElement('button');
                button.className = 'w-full btn-palace py-4 text-center';
                button.innerHTML = `
                    <div class="text-xl mb-1">${option.icon}</div>
                    <div class="font-bold text-lg">${option.name}</div>
                    <div class="text-xs opacity-75 mt-1">${option.desc}</div>
                `;
                button.onclick = () => handleHeartRoomInsideChoice(option);
                optionsDiv.appendChild(button);
            });
        }

        // 处理养心殿内部选择
        async function handleHeartRoomInsideChoice(option) {
            // 显示加载状态
            document.getElementById('heartroom-inside-options').innerHTML = '';
            document.getElementById('heartroom-inside-loading').classList.remove('hidden');

            showAILoading();

            try {
                const requestData = {
                    皇帝个人信息: gameState.皇帝个人信息,
                    妃嫔信息: gameState.妃嫔信息,
                    玩家详细信息: gameState.玩家详细信息,
                    初始好感度信息: gameState.初始好感度信息,
                    事件簿: gameState.events_log.slice(-10),
                    求见事件: heartRoomData.requestEvent,
                    求见结果: heartRoomData.selectedOption,
                    选择的内部选项: option.name,
                    当前时间: `${gameState.current_year}年${gameState.current_month}月`
                };

                const response = await fetch('/generate_heartroom_inside_result', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(requestData)
                });

                const data = await response.json();
                hideAILoading();

                if (data.success) {
                    displayHeartRoomInsideResult(data.result);
                } else {
                    alert("生成养心殿内部结果失败");
                    backToMainGameFromHeartroom();
                }
            } catch (e) {
                hideAILoading();
                alert("连接失败");
                backToMainGameFromHeartroom();
            }
        }

        // 显示养心殿内部结果
        function displayHeartRoomInsideResult(resultData) {
            document.getElementById('heartroom-inside-loading').classList.add('hidden');

            // 显示结果描述
            document.getElementById('heartroom-inside-result-description').innerHTML = 
                `<p class="leading-relaxed">${resultData.事件描述}</p>`;

            // 显示属性变动
            const changesDiv = document.getElementById('heartroom-inside-result-changes');
            let changesHtml = '';

            // 玩家属性变动
            if (resultData.玩家属性变动) {
                for (const attr in resultData.玩家属性变动) {
                    const change = resultData.玩家属性变动[attr];
                    if (change !== 0) {
                        const color = change > 0 ? 'text-green-600' : 'text-red-600';
                        changesHtml += `<div class="flex justify-between p-1">
                            <span class="text-xs">${attr}</span>
                            <span class="${color} text-xs">${change > 0 ? '+' : ''}${change}</span>
                        </div>`;
                    }
                }
            }

            // 好感度变动
            if (resultData.人物好感度变动) {
                for (const person in resultData.人物好感度变动) {
                    const change = resultData.人物好感度变动[person];
                    if (change !== 0) {
                        const color = change > 0 ? 'text-pink-600' : 'text-blue-600';
                        changesHtml += `<div class="flex justify-between p-1">
                            <span class="text-xs">${person}好感</span>
                            <span class="${color} text-xs">${change > 0 ? '+' : ''}${change}</span>
                        </div>`;
                    }
                }
            }

            // 妃嫔属性变动
            if (resultData.妃嫔属性变动 && Array.isArray(resultData.妃嫔属性变动)) {
                resultData.妃嫔属性变动.forEach(change => {
                    if (change.圣宠变动 !== 0 || change.权势变动 !== 0) {
                        const favorColor = change.圣宠变动 > 0 ? 'text-yellow-600' : 'text-gray-600';
                        const powerColor = change.权势变动 > 0 ? 'text-purple-600' : 'text-gray-600';

                        if (change.圣宠变动 !== 0) {
                            changesHtml += `<div class="flex justify-between p-1">
                                <span class="text-xs">${change.姓名}·圣宠</span>
                                <span class="${favorColor} text-xs">${change.圣宠变动 > 0 ? '↑+' : '↓'}${change.圣宠变动}</span>
                            </div>`;
                        }

                        if (change.权势变动 !== 0) {
                            changesHtml += `<div class="flex justify-between p-1">
                                <span class="text-xs">${change.姓名}·权势</span>
                                <span class="${powerColor} text-xs">${change.权势变动 > 0 ? '↑+' : '↓'}${change.权势变动}</span>
                            </div>`;
                        }
                    }
                });
            }

            changesDiv.innerHTML = changesHtml;

            // 显示结果区域
            document.getElementById('heartroom-inside-result').classList.remove('hidden');

            // 应用属性变动
            applyHeartRoomInsideResult(resultData);

            // 记录事件
            const timeKey = `${gameState.current_year}年${gameState.current_month}月`;
            if (resultData.事件概括) {
                const eventLog = { 
                    time: timeKey, 
                    content: `【养心殿】${resultData.事件概括}` 
                };
                gameState.events_log.push(eventLog);
                addMonthEvent(resultData.事件概括);
            }
        }

        // 应用养心殿内部结果
        function applyHeartRoomInsideResult(resultData) {
            // 玩家属性变动
            if (resultData.玩家属性变动) {
                for (const attr in resultData.玩家属性变动) {
                    if (gameState.玩家详细信息.各项属性[attr] !== undefined) {
                        gameState.玩家详细信息.各项属性[attr] += resultData.玩家属性变动[attr];
                        gameState.玩家详细信息.各项属性[attr] = Math.max(0, Math.min(100, gameState.玩家详细信息.各项属性[attr]));
                    }
                }
            }

            // 好感度变动
            if (resultData.人物好感度变动) {
                for (const person in resultData.人物好感度变动) {
                    const key = (person === "皇上" || person === gameState.皇帝个人信息.姓名) ? "皇上" : person;
                    if (gameState.初始好感度信息[key] === undefined) gameState.初始好感度信息[key] = 0;
                    gameState.初始好感度信息[key] += resultData.人物好感度变动[person];
                }
            }

            // 妃嫔属性变动
            if (resultData.妃嫔属性变动 && Array.isArray(resultData.妃嫔属性变动)) {
                resultData.妃嫔属性变动.forEach(change => {
                    const concubine = gameState.妃嫔信息.find(c => c.姓名 === change.姓名);
                    if (concubine) {
                        if (concubine.宠爱度 === undefined) concubine.宠爱度 = 0;
                        if (concubine.权势 === undefined) concubine.权势 = 0;

                        concubine.宠爱度 += change.圣宠变动 || 0;
                        concubine.宠爱度 = Math.max(0, Math.min(100, concubine.宠爱度));

                        concubine.权势 += change.权势变动 || 0;
                        concubine.权势 = Math.max(0, Math.min(100, concubine.权势));
                    }
                });
            }
        }

        // 完成养心殿事件
        function finishHeartroomEvent() {
            // 重置养心殿数据
            heartRoomData = {
                situation: '',
                eventTemplate: '',
                requestEvent: {},
                requestChoice: '',
                requestResult: {},
                accessGranted: false
            };

            // 返回主界面
            switchScreen('main-game-screen');
            updateUI();
            autoSaveToSlot5();

            // 检查行动点
            if (gameState.action_points <= 0) {
                setTimeout(() => {
                    if (confirm("本月行动点已用尽，是否直接进入下个月？")) passMonth();
                }, 500);
            }
        }

        // 返回主界面（从求见界面）
        function backToMainGameFromHeartroom() {
            // 重置养心殿数据
            heartRoomData = {
                situation: '',
                eventTemplate: '',
                requestEvent: {},
                requestChoice: '',
                requestResult: {},
                accessGranted: false
            };

            // 返回主界面
            switchScreen('main-game-screen');
            updateUI();
            autoSaveToSlot5();
        }

        // 养心殿错误处理
        function showHeartRoomError(message) {
            document.getElementById('heartroom-loading').classList.add('hidden');
            document.getElementById('heartroom-event-description').innerHTML = 
                `<p class="text-red-700 font-bold text-center">${message}</p>`;

            // 恢复行动点（因为事件生成失败）
            gameState.action_points++;

            gameState.heartroom_visits_this_month--;

            document.getElementById('heartroom-back-btn').classList.remove('hidden');
        }

        // 检查太医人数，如果少于3人则生成新太医
        async function checkAndGenerateDoctors() {
            // 先更新太医人数显示
            updateHospitalDoctorCount();
            
            if (gameState.太医列表.length < 3) {
                // 显示生成状态，禁用太医列表按钮
                showDoctorGeneratingStatus(true);
                try {
                    const response = await fetch('/generate_doctors', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            皇帝个人信息: gameState.皇帝个人信息,
                            妃嫔信息: gameState.妃嫔信息,
                            玩家详细信息: gameState.玩家详细信息,
                            当前太医人数: gameState.太医列表.length
                        })
                    });

                    const data = await response.json();
                    hideAILoading();

                    if (data.success && data.doctors && data.doctors.length > 0) {
                        // 添加新太医到列表，避免重复
                        data.doctors.forEach(newDoctor => {
                            if (!gameState.太医列表.some(d => d.姓名 === newDoctor.姓名)) {
                                // 初始化好感度为0
                                if (gameState.初始好感度信息[newDoctor.姓名] === undefined) {
                                    gameState.初始好感度信息[newDoctor.姓名] = 0;
                                }
                                gameState.太医列表.push(newDoctor);
                            }
                        });

                        // 记录事件
                        const timeKey = `${gameState.current_year}年${gameState.current_month}月`;
                        gameState.events_log.push({
                            time: timeKey,
                            content: `【太医院】新太医入宫：${data.doctors.map(d => d.姓名).join('、')}`
                        });
                    }
                } catch (e) {
                    hideAILoading();
                    console.error("生成太医失败:", e);
                } finally {
                    // 隐藏生成状态，恢复按钮
                    showDoctorGeneratingStatus(false);
                    // 更新太医人数显示
                    updateHospitalDoctorCount();
                }
            }
        }
        
        // 显示/隐藏太医生成状态
        function showDoctorGeneratingStatus(show) {
            const statusEl = document.getElementById('hospital-generating-status');
            const doctorListBtn = document.querySelector('#step-hospital-main button[onclick="showDoctorList()"]');

            if (statusEl) {
                if (show) {
                    statusEl.classList.remove('hidden');
                } else {
                    statusEl.classList.add('hidden');
                }
            }

            if (doctorListBtn) {
                if (show) {
                    doctorListBtn.disabled = true;
                    doctorListBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    doctorListBtn.title = "太医采选中，请稍候...";
                } else {
                    doctorListBtn.disabled = false;
                    doctorListBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    doctorListBtn.title = "查看所有太医";
                }
            }
        }

        // 更新太医人数显示（独立的函数，方便调用）
        function updateHospitalDoctorCount() {
            const countEl = document.getElementById('hospital-doctor-count');
            const countEl2 = document.getElementById('doctor-count');

            if (countEl) {
                countEl.textContent = gameState.太医列表.length;
            }
            if (countEl2) {
                countEl2.textContent = gameState.太医列表.length;
            }
        }

        // === 太医院相关函数 ===

        // 全局变量存储当前选中的太医
        let selectedDoctor = null;
        let hospitalData = {
            nurturedThisMonth: false,  // 本月是否已调养
            lastInteractType: ''       // 上次互动类型
        };

        // 访问太医院
        function visitHospital() {
            if (gameState.action_points <= 0) {
                alert("本月行动点已用尽，请结束本月");
                return;
            }

            // 扣减行动点
            // gameState.action_points--;

            // 检查太医人数，如果少于3人则生成新太医
            checkAndGenerateDoctors();

            // 切换到太医院主界面
            switchScreen('step-hospital-main');

            // 更新界面信息
            updateHospitalUI();
        }

        // 更新太医院界面信息
        function updateHospitalUI() {
            // 更新太医人数 - 这里也调用更新人数的函数
            updateHospitalDoctorCount();  // 新增这一行

            // 更新调养状态
            document.getElementById('hospital-nurtured-this-month').textContent = 
                hospitalData.nurturedThisMonth ? '是' : '否';

            // 更新调养按钮状态
            const nurtureBtn = document.getElementById('nurture-body-btn');
            if (hospitalData.nurturedThisMonth) {
                nurtureBtn.disabled = true;
                nurtureBtn.classList.add('opacity-50', 'cursor-not-allowed');
                nurtureBtn.title = "本月已调养过身体";
            } else {
                nurtureBtn.disabled = false;
                nurtureBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                nurtureBtn.title = "调养身体（每月限一次）";
            }
        }

        // 返回主界面
        function backToMainGameFromHospital() {
            switchScreen('main-game-screen');
            updateUI();
            autoSaveToSlot5();
        }

        // 返回太医院主界面
        function backToHospitalMain() {
            switchScreen('step-hospital-main');
            updateHospitalUI();
        }

        // 显示太医列表
        function showDoctorList() {
            switchScreen('step-doctor-list');

            // 更新太医人数
            document.getElementById('doctor-count').textContent = gameState.太医列表.length;

            const container = document.getElementById('doctor-list-container');
            const emptyState = document.getElementById('doctor-empty-state');

            if (gameState.太医列表.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            container.innerHTML = '';

            // 为每个太医创建卡片
            gameState.太医列表.forEach((doctor, index) => {
                const card = document.createElement('div');
                card.className = 'bg-white border border-gray-200 rounded-lg p-3 shadow-sm cursor-pointer hover:shadow-md transition-all';
                card.onclick = () => selectDoctor(doctor);

                const favor = gameState.初始好感度信息[doctor.姓名] || 0;
                const favorColor = favor > 20 ? 'text-green-600' : favor < -10 ? 'text-red-600' : 'text-gray-600';

                card.innerHTML = `
                    <div class="flex items-center">
                        <div class="text-2xl mr-3">👨‍⚕️</div>
                        <div class="flex-grow">
                            <div class="flex justify-between items-baseline">
                                <span class="font-bold text-gray-800">${doctor.姓名}</span>
                                <span class="text-xs px-2 py-0.5 rounded ${doctor.品级.includes('一') ? 'bg-red-100 text-red-800' : doctor.品级.includes('二') ? 'bg-orange-100 text-orange-800' : 'bg-gray-100 text-gray-800'}">${doctor.品级}</span>
                            </div>
                            <div class="text-xs text-gray-500 mt-1">医术：${doctor.医术值} | 听命于：${doctor.听命于 || '无'}</div>
                            <div class="text-xs mt-1 ${favorColor}">好感度：${favor > 0 ? '+' : ''}${favor}</div>
                        </div>
                        <div class="text-gray-400">▶</div>
                    </div>
                `;

                container.appendChild(card);
            });
        }

        // 选择太医
        function selectDoctor(doctor) {
            selectedDoctor = doctor;

            // 更新太医详情界面
            document.getElementById('doctor-detail-name').textContent = doctor.姓名;
            document.getElementById('doctor-detail-rank').textContent = doctor.品级;
            document.getElementById('doctor-age').textContent = doctor.年龄;
            document.getElementById('doctor-personality').textContent = doctor.性格;
            document.getElementById('doctor-rank').textContent = doctor.品级;
            document.getElementById('doctor-skill').textContent = doctor.医术值;
            document.getElementById('doctor-serves').textContent = doctor.听命于 || '无';

            const favor = gameState.初始好感度信息[doctor.姓名] || 0;
            document.getElementById('doctor-favor').textContent = favor;
            document.getElementById('doctor-favor-bar').style.width = `${Math.min(100, Math.max(0, favor + 50))}%`;

            // 更新互动按钮状态
            updateDoctorInteractionButtons(doctor);

            // 切换到太医详情界面
            switchScreen('step-doctor-detail');
        }

        // 更新互动按钮状态
        function updateDoctorInteractionButtons(doctor) {
            const learnBtn = document.getElementById('learn-from-doctor-btn');
            const recruitBtn = document.getElementById('recruit-doctor-btn');
            const discordBtn = document.getElementById('sow-discord-btn');
            const hintDiv = document.getElementById('doctor-interaction-hint');

            // 重置所有按钮和提示
            learnBtn.classList.remove('hidden');
            recruitBtn.classList.remove('hidden');
            discordBtn.classList.remove('hidden');
            hintDiv.classList.add('hidden');

            // 重置所有按钮状态
            learnBtn.disabled = false;
            learnBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            recruitBtn.disabled = false;
            recruitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            discordBtn.disabled = false;
            discordBtn.classList.remove('opacity-50', 'cursor-not-allowed');

            // 根据太医状态设置按钮
            if (doctor.听命于 === gameState.玩家详细信息.姓名) {
                // 情况1：太医已听命于玩家
                recruitBtn.disabled = true;
                recruitBtn.classList.add('opacity-50', 'cursor-not-allowed');
                discordBtn.disabled = true;
                discordBtn.classList.add('opacity-50', 'cursor-not-allowed');

                hintDiv.classList.remove('hidden');
                hintDiv.innerHTML = '此太医已听命于你，无需拉拢或挑拨';
                hintDiv.className = 'text-xs text-green-500 text-center p-2 bg-green-100 rounded';
            } else if (doctor.听命于 && doctor.听命于 !== '无' && doctor.听命于 !== '') {
                // 情况2：太医听命于其他妃嫔
                // 拉拢可用（可以尝试直接拉拢）
                recruitBtn.disabled = false;
                recruitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                // 挑拨也可用
                discordBtn.disabled = false;
                discordBtn.classList.remove('opacity-50', 'cursor-not-allowed');

                hintDiv.classList.remove('hidden');
                hintDiv.innerHTML = `此太医听命于${doctor.听命于}，你可以尝试拉拢或挑拨`;
                hintDiv.className = 'text-xs text-yellow-600 text-center p-2 bg-yellow-100 rounded';
            } else {
                // 情况3：太医无听命于的主子（听命于为'无'或空）
                // 拉拢可用
                recruitBtn.disabled = false;
                recruitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                // 挑拨禁用（因为没有主子可以挑拨）
                discordBtn.disabled = true;
                discordBtn.classList.add('opacity-50', 'cursor-not-allowed');

                hintDiv.classList.remove('hidden');
                hintDiv.innerHTML = '此太医暂无主子，可以尝试拉拢';
                hintDiv.className = 'text-xs text-blue-500 text-center p-2 bg-blue-100 rounded';
            }
        }

        // 返回太医列表
        function backToDoctorList() {
            selectedDoctor = null;
            switchScreen('step-doctor-list');
        }

        // 返回太医详情
        function backToDoctorDetail() {
            if (selectedDoctor) {
                selectDoctor(selectedDoctor);
            } else {
                backToDoctorList();
            }
        }

        // 调养身体
        function nurtureBody() {
            if (hospitalData.nurturedThisMonth) {
                alert("本月已经调养过身体，请下月再来");
                return;
            }

            gameState.action_points--;

            // 随机增加健康值和体力值
            const healthIncrease = Math.floor(Math.random() * 6); // 0-5
            const staminaIncrease = Math.floor(Math.random() * 6); // 0-5

            // 应用属性变动
            gameState.玩家详细信息.各项属性.健康 += healthIncrease;
            gameState.玩家详细信息.各项属性.体力 += staminaIncrease;

            // 限制最大值
            gameState.玩家详细信息.各项属性.健康 = Math.min(100, gameState.玩家详细信息.各项属性.健康);
            gameState.玩家详细信息.各项属性.体力 = Math.min(100, gameState.玩家详细信息.各项属性.体力);

            // 标记本月已调养
            hospitalData.nurturedThisMonth = true;

            // 记录事件
            const timeKey = `${gameState.current_year}年${gameState.current_month}月`;
            const eventText = `【太医院调养】在太医院调养身体，健康+${healthIncrease}，体力+${staminaIncrease}`;

            gameState.events_log.push({
                time: timeKey,
                content: eventText
            });

            addMonthEvent(eventText);

            // 显示结果
            showHospitalFixedEvent(
                "调养身体",
                `你在太医院的药房中稍作休息，太医为你准备了温和的补药。服下后感觉身体舒畅了许多。`,
                {
                    "健康": healthIncrease,
                    "体力": staminaIncrease
                }
            );
        }

        // 学习医术
        function learnMedicine() {
            // 随机增加医术值
            const medicineIncrease = Math.floor(Math.random() * 4); // 0-3

            gameState.action_points--;

            // 应用属性变动
            gameState.玩家详细信息.各项属性.医术 += medicineIncrease;
            gameState.玩家详细信息.各项属性.体力 -= 5; // 扣减体力

            // 限制最大值和最小值
            gameState.玩家详细信息.各项属性.医术 = Math.min(100, gameState.玩家详细信息.各项属性.医术);
            gameState.玩家详细信息.各项属性.体力 = Math.max(0, gameState.玩家详细信息.各项属性.体力);

            // 记录事件
            const timeKey = `${gameState.current_year}年${gameState.current_month}月`;
            const eventText = `【学习医术】在太医院学习医术知识，医术+${medicineIncrease}，体力-5`;

            gameState.events_log.push({
                time: timeKey,
                content: eventText
            });

            addMonthEvent(eventText);

            // 显示结果
            showHospitalFixedEvent(
                "学习医术",
                `你向太医请教医术知识，认真研读医书。虽然有些疲惫，但对医术的理解有所提升。`,
                {
                    "医术": medicineIncrease,
                    "体力": -5
                }
            );
        }

        // 显示固定事件结果
        function showHospitalFixedEvent(title, description, changes) {
            switchScreen('step-hospital-event');

            document.getElementById('hospital-event-title').textContent = title;
            document.getElementById('hospital-event-description').innerHTML = `<p class="leading-relaxed">${description}</p>`;
            document.getElementById('hospital-loading').classList.add('hidden');

            // 显示属性变动
            const changesDiv = document.getElementById('hospital-result-changes');
            let changesHtml = '';

            for (const attr in changes) {
                const change = changes[attr];
                if (change !== 0) {
                    const color = change > 0 ? 'text-green-600' : 'text-red-600';
                    changesHtml += `<div class="flex justify-between p-1">
                        <span class="text-xs">${attr}</span>
                        <span class="${color} text-xs">${change > 0 ? '+' : ''}${change}</span>
                    </div>`;
                }
            }

            changesDiv.innerHTML = changesHtml;
            document.getElementById('hospital-result').classList.remove('hidden');
        }

        // 随便逛逛
        function wanderHospital() {
            showAILoading();
            // 切换到事件界面
            switchScreen('step-hospital-event');
            document.getElementById('hospital-event-title').textContent = "太医院偶遇";
            document.getElementById('hospital-event-description').innerHTML = '';
            document.getElementById('hospital-loading').classList.remove('hidden');
            document.getElementById('hospital-result').classList.add('hidden');

            // 调用后端生成随机事件
            fetch('/generate_hospital_event', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    皇帝个人信息: gameState.皇帝个人信息,
                    妃嫔信息: gameState.妃嫔信息,
                    太医列表: gameState.太医列表,
                    玩家详细信息: gameState.玩家详细信息,
                    初始好感度信息: gameState.初始好感度信息,
                    事件簿: gameState.events_log.slice(-50),
                    当前时间: `${gameState.current_year}年${gameState.current_month}月`
                })
            })
            .then(response => response.json())
            .then(data => {
                hideAILoading();
                if (data.success) {
                    gameState.action_points--;
                    displayHospitalEventResult(data.event);
                } else {
                    alert("生成太医院事件失败");
                    backToHospitalMain();
                }
            })
            .catch(e => {
                hideAILoading();
                alert("连接失败");
                backToHospitalMain();
            });
        }

        // 请教医术
        function learnFromDoctor() {
            if (!selectedDoctor) return;

            hospitalData.lastInteractType = 'learn';
            showAILoading();

            switchScreen('step-hospital-event');
            document.getElementById('hospital-event-title').textContent = "请教医术";
            document.getElementById('hospital-event-description').innerHTML = '';
            document.getElementById('hospital-loading').classList.remove('hidden');
            document.getElementById('hospital-result').classList.add('hidden');

            fetch('/doctor_learn_medicine', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    太医信息: selectedDoctor,
                    玩家详细信息: gameState.玩家详细信息,
                    听命于妃子详细信息: gameState.妃嫔信息.find(c => c.姓名 === selectedDoctor.听命于) || null,
                    近期事件: gameState.events_log.slice(-50),
                    初始好感度信息: gameState.初始好感度信息,
                    当前时间: `${gameState.current_year}年${gameState.current_month}月`
                })
            })
            .then(response => response.json())
            .then(data => {
                hideAILoading();
                if (data.success) {
                    gameState.action_points--;
                    displayHospitalEventResult(data.event, true);
                } else {
                    alert("请教医术失败");
                    backToDoctorDetail();
                }
            })
            .catch(e => {
                hideAILoading();
                alert("连接失败");
                backToDoctorDetail();
            });
        }

        // 拉拢太医
        function recruitDoctor() {
            if (!selectedDoctor) return;

            hospitalData.lastInteractType = 'recruit';
            showAILoading();

            switchScreen('step-hospital-event');
            document.getElementById('hospital-event-title').textContent = "拉拢太医";
            document.getElementById('hospital-event-description').innerHTML = '';
            document.getElementById('hospital-loading').classList.remove('hidden');
            document.getElementById('hospital-result').classList.add('hidden');

            fetch('/doctor_recruit', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    太医信息: selectedDoctor,
                    玩家详细信息: gameState.玩家详细信息,
                    妃嫔信息: gameState.妃嫔信息,
                    初始好感度信息: gameState.初始好感度信息,
                    事件簿: gameState.events_log.slice(-50),
                    当前时间: `${gameState.current_year}年${gameState.current_month}月`
                })
            })
            .then(response => response.json())
            .then(data => {
                hideAILoading();
                if (data.success) {
                    gameState.action_points--;
                    displayHospitalEventResult(data.event, true);
                } else {
                    alert("拉拢太医失败");
                    backToDoctorDetail();
                }
            })
            .catch(e => {
                hideAILoading();
                alert("连接失败");
                backToDoctorDetail();
            });
        }

        // 挑拨离间
        function sowDiscord() {
            if (!selectedDoctor) return;

            hospitalData.lastInteractType = 'discord';
            showAILoading();

            switchScreen('step-hospital-event');
            document.getElementById('hospital-event-title').textContent = "挑拨离间";
            document.getElementById('hospital-event-description').innerHTML = '';
            document.getElementById('hospital-loading').classList.remove('hidden');
            document.getElementById('hospital-result').classList.add('hidden');

            fetch('/doctor_sow_discord', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    太医信息: selectedDoctor,
                    玩家详细信息: gameState.玩家详细信息,
                    妃嫔信息: gameState.妃嫔信息,
                    初始好感度信息: gameState.初始好感度信息,
                    事件簿: gameState.events_log.slice(-50),
                    当前时间: `${gameState.current_year}年${gameState.current_month}月`
                })
            })
            .then(response => response.json())
            .then(data => {
                hideAILoading();
                if (data.success) {
                    gameState.action_points--;
                    displayHospitalEventResult(data.event, true);
                } else {
                    alert("挑拨离间失败");
                    backToDoctorDetail();
                }
            })
            .catch(e => {
                hideAILoading();
                alert("连接失败");
                backToDoctorDetail();
            });
        }

        // 显示太医院事件结果
        function displayHospitalEventResult(eventData, isDoctorInteract = false) {
            document.getElementById('hospital-loading').classList.add('hidden');
            document.getElementById('hospital-event-description').innerHTML = 
                `<p class="leading-relaxed">${eventData.事件描述}</p>`;

            // 显示属性变动
            const changesDiv = document.getElementById('hospital-result-changes');
            let changesHtml = '';

            // 玩家属性变动
            if (eventData.玩家属性变动) {
                for (const attr in eventData.玩家属性变动) {
                    const change = eventData.玩家属性变动[attr];
                    if (change !== 0) {
                        const color = change > 0 ? 'text-green-600' : 'text-red-600';
                        changesHtml += `<div class="flex justify-between p-1">
                            <span class="text-xs">${attr}</span>
                            <span class="${color} text-xs">${change > 0 ? '+' : ''}${change}</span>
                        </div>`;

                        // 应用属性变动
                        if (gameState.玩家详细信息.各项属性[attr] !== undefined) {
                            gameState.玩家详细信息.各项属性[attr] += change;
                            gameState.玩家详细信息.各项属性[attr] = Math.max(0, Math.min(100, gameState.玩家详细信息.各项属性[attr]));
                        }
                    }
                }
            }

            // 好感度变动
            if (eventData.人物好感度变动) {
                for (const person in eventData.人物好感度变动) {
                    const change = eventData.人物好感度变动[person];
                    if (change !== 0) {
                        const color = change > 0 ? 'text-pink-600' : 'text-blue-600';
                        changesHtml += `<div class="flex justify-between p-1">
                            <span class="text-xs">${person}好感</span>
                            <span class="${color} text-xs">${change > 0 ? '+' : ''}${change}</span>
                        </div>`;

                        // 应用好感度变动
                        const key = (person === "皇上" || person === gameState.皇帝个人信息.姓名) ? "皇上" : person;
                        if (gameState.初始好感度信息[key] === undefined) gameState.初始好感度信息[key] = 0;
                        gameState.初始好感度信息[key] += change;
                    }
                }
            }

            changesDiv.innerHTML = changesHtml;
            document.getElementById('hospital-result').classList.remove('hidden');

            // 如果是太医互动，更新太医状态
            if (isDoctorInteract && selectedDoctor) {
                // 更新太医信息（如果事件返回了新的太医信息）
                if (eventData.太医更新信息) {
                    const doctorIndex = gameState.太医列表.findIndex(d => d.姓名 === selectedDoctor.姓名);
                    if (doctorIndex !== -1) {
                        gameState.太医列表[doctorIndex] = {
                            ...gameState.太医列表[doctorIndex],
                            ...eventData.太医更新信息
                        };
                        selectedDoctor = gameState.太医列表[doctorIndex];
                    }
                }
            }

            // 记录事件
            const timeKey = `${gameState.current_year}年${gameState.current_month}月`;
            let eventContent = `【太医院】`;

            if (hospitalData.lastInteractType === 'learn') {
                eventContent += `向${selectedDoctor?.姓名}请教医术`;
            } else if (hospitalData.lastInteractType === 'recruit') {
                eventContent += ``;
            } else if (hospitalData.lastInteractType === 'discord') {
                eventContent += ``;
            } else {
                eventContent += `太医院偶遇事件`;
            }

            if (eventData.事件概括) {
                eventContent += `：${eventData.事件概括}`;
            }

            gameState.events_log.push({
                time: timeKey,
                content: eventContent
            });

            addMonthEvent(eventContent);
        }

        // 完成太医院事件
        function finishHospitalEvent() {
            // 返回主界面，而不是太医院主界面
            switchScreen('main-game-screen');
            updateUI(); // 更新主界面UI
            autoSaveToSlot5(); // 自动存档

            // 重置相关变量
            selectedDoctor = null;
            hospitalData.lastInteractType = '';

            // 检查行动点是否用完
            if (gameState.action_points <= 0) {
                setTimeout(() => {
                    if (confirm("本月行动点已用尽，是否直接进入下个月？")) passMonth();
                }, 500);
            }
        }
    </script>
</body>
</html>
